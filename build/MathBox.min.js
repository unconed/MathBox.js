var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,b){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(b)},unbind:function(a,b){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(b),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var b=0;b<this._events[a].length;b++)this._events[a][b].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);
function microAjax(a,b,c){this.bindFunction=function(a,b){return function(){return a.apply(b,[b])}};this.stateChange=function(a){4==this.request.readyState&&this.callbackFunction(this.request.responseText)};this.getRequest=function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:!1};this.postBody=c||"";this.callbackFunction=b;this.url=a;if(this.request=this.getRequest())b=this.request,b.onreadystatechange=this.bindFunction(this.stateChange,
this),""!==this.postBody?(b.open("POST",a,!0),b.setRequestHeader("X-Requested-With","XMLHttpRequest"),b.setRequestHeader("Content-type","application/x-www-form-urlencoded"),b.setRequestHeader("Connection","close")):b.open("GET",a,!0),b.send(this.postBody)}var \u03c0=Math.PI,\u03c4=2*\u03c0;(function(a){for(var b in a)if(!window[b])throw"Error: ThreeBox requires "+a[b];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)"});window.ThreeBox={};
window.threeBox=function(a,b){!a||a instanceof Node||(b=a,a=null);return tQuery.createWorld(b).threeBox(a,b)};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};tQuery.World.prototype.on=tQuery.World.prototype.addEventListener;
tQuery.World.prototype.emit=tQuery.World.prototype.dispatchEvent;tQuery.World.registerInstance("threeBox",function(a,b){!a||a instanceof Node||(b=a,a=null);var c=a=a||document.body;a==document.body?(c.style.margin=0,c.style.padding=0,c.style.overflow="hidden"):(getComputedStyle(a),"static"==a.position&&(a.position="relative"));this.appendTo(c);this.addThreeBox(a,b||{});return this});
tQuery.World.registerInstance("addThreeBox",function(a,b){console.assert(!0!==this.hasThreeBox());b=tQuery.extend(b,{cameraControls:!1,cursor:!0,controlClass:ThreeBox.OrbitControls,elementResize:!0,fullscreen:!0,screenshot:!0,stats:!0,scale:1});this.tRenderer().domElement.style.display="block";var c={};tQuery.data(this,"_threeBoxContext",c);var d=this.tCamera(),e=this.tRenderer();b.stats&&(c.stats=new Stats,c.stats.domElement.style.position="absolute",c.stats.domElement.style.left="10px",c.stats.domElement.style.top=
"10px",a&&a.appendChild(c.stats.domElement),c.loopStats=function(){c.stats.update()},this.loop().hook(c.loopStats));if(b.cameraControls){var f=this.loop(),h=this.render.bind(this);c.cameraControls=new b.controlClass(d,a,b);if(c.cameraControls.on)c.cameraControls.on("change",function(){f._timerId||h()});this.setCameraControls(c.cameraControls)}b.elementResize&&(c.elementResize=ThreeBox.ElementResize.bind(e,d,a,b).on("resize",function(a,b){this._opts.renderW=a;this._opts.renderH=b;this.emit("resize",
a,b)}.bind(this)));null!==b.cursor&&(c.cursor=ThreeBox.Cursor.bind(a,b));THREEx&&THREEx.Screenshot&&b.screenshot&&(c.screenshot=THREEx.Screenshot.bindKey(e));THREEx&&THREEx.FullScreen&&b.fullscreen&&THREEx.FullScreen.available()&&(c.fullscreen=THREEx.FullScreen.bindKey());c._$onDestroy=this.bind("destroy",function(){!1!==this.hasThreeBox()&&this.removeThreeBox()});return this});tQuery.World.registerInstance("hasThreeBox",function(){return void 0===tQuery.data(this,"_threeBoxContext")?!1:!0});
tQuery.World.registerInstance("removeThreeBox",function(){var a=tQuery.data(this,"_threeBoxContext");if(void 0===a)return this;tQuery.removeData(this,"_threeBoxContext");this.unbind("destroy",this._$onDestroy);a.stats&&(document.body.removeChild(a.stats.domElement),this.loop().unhook(a.loopStats));a.cameraControls&&this.removeCameraControls()&&a.cameraControls.stop();a.elementResize&&a.elementResize.unbind();a.cursor&&a.cursor.unbind();a.screenshot&&a.screenshot.unbind();a.fullscreen&&a.fullscreen.unbind()});
ThreeBox.ElementResize=function(a,b,c,d){this.scale=d.scale||1;this.orbit=d.orbit;d=this.callback=function(){var d=Math.floor(c.offsetWidth),f=Math.floor(c.offsetHeight);a.domElement.style.position="absolute";a.domElement.style.width=d+"px";a.domElement.style.height=f+"px";var h=Math.floor(d/this.scale),k=Math.floor(f/this.scale);a.setSize(h,k);b.aspect=d/f;b instanceof THREE.OrthographicCamera&&(b.top=this.orbit/2,b.bottom=-b.top,b.left=-b.top*b.aspect,b.right=-b.bottom*b.aspect);b.updateProjectionMatrix();
this.emit("resize",h,k)}.bind(this);window.addEventListener("resize",d,!1);c.addEventListener("resize",d,!1);setTimeout(d,0)};ThreeBox.ElementResize.bind=function(a,b,c,d){return new ThreeBox.ElementResize(a,b,c,d)};ThreeBox.ElementResize.prototype.scale=function(a){this.scale=a};ThreeBox.ElementResize.prototype.unbind=function(){window.removeEventListener("resize",callback);domElement.removeEventListener("resize",callback)};MicroEvent.mixin(ThreeBox.ElementResize);
ThreeBox.OrbitControls=function(a,b,c){this.element=b;this.camera=a;this.options=tQuery.extend(c,{phi:\u03c4/4,theta:0.3,orbit:2,lookAt:[0,0,0],speed:2});this.init();this.start();this.update()};
ThreeBox.OrbitControls.prototype={init:function(){this.width=this.element&&this.element.offsetWidth;this.height=this.element&&this.element.offsetHeight;this.phi=this.options.phi;this.theta=this.options.theta;this.orbit=this.options.orbit;this.speed=this.options.speed;this.lookAt=new THREE.Vector3;this.lookAt.set.apply(this.lookAt,this.options.lookAt||[])},start:function(){var a=this;this._mouseDown=function(b){a.width=a.element&&a.element.offsetWidth;a.height=a.element&&a.element.offsetHeight;a.drag=
!0;a.lastHover=a.origin={x:b.pageX,y:b.pageY};b.preventDefault()};this._mouseUp=function(){a.drag=!1};this._mouseMove=function(b){if(a.drag){var c={x:b.pageX-a.origin.x,y:b.pageY-a.origin.y},d={x:b.pageX-a.lastHover.x,y:b.pageY-a.lastHover.y};a.lastHover={x:b.pageX,y:b.pageY};a.moved(a.origin,c,d)}};this.element&&(this.element.addEventListener("mousedown",this._mouseDown,!1),document.addEventListener("mouseup",this._mouseUp,!1),document.addEventListener("mousemove",this._mouseMove,!1))},stop:function(){this.element&&
(this.element.removeEventListener("mousedown",this._mouseDown),document.removeEventListener("mouseup",this._mouseUp),document.removeEventListener("mousemove",this._mouseMove))},moved:function(a,b,c){this.phi+=c.x*this.speed/this.width;this.theta=Math.min(\u03c0/2,Math.max(-\u03c0/2,this.theta+c.y*this.speed/this.height));this.emit("change")},update:function(){this.camera.position.x=Math.cos(this.phi)*Math.cos(this.theta)*this.orbit;this.camera.position.y=Math.sin(this.theta)*this.orbit;this.camera.position.z=
Math.sin(this.phi)*Math.cos(this.theta)*this.orbit;this.camera.position.addSelf(this.lookAt);this.camera.lookAt(this.lookAt)}};ThreeBox.OrbitControls.bind=function(a,b,c){return new ThreeBox.OrbitControls(a,b,c)};MicroEvent.mixin(ThreeBox.OrbitControls);
ThreeBox.Cursor=function(a,b){function c(){f||(a.style.cursor=d);clearTimeout(e);f=!1;e=setTimeout(function(){f=!0;a.style.cursor="none"},h)}var d=b.cameraControls?"move":"default",e=null,f=!1,h=2E3;b.cursor?a.style.cursor=d:(a.addEventListener("mousemove",c),a.style.cursor="none");return{unbind:function(){a.removeEventListener("mousemove",c)}}};ThreeBox.Cursor.bind=function(a,b){return ThreeBox.Cursor(a,b)};
ThreeBox.preload=function(a,b){a instanceof Function&&(b=a,a=[]);a="string"==typeof a?[a]:a;var c=a.length,d={},e=function(a){_.extend(d,a||{});0==--c&&b(d)},f=ThreeBox.preload,h={},k={html:f.html,jpg:f.image,png:f.image,gif:f.image,mp3:f.audio};_.each(k,function(a,b){h[b]=RegExp("\\."+b+"$")});_.each(a,function(a){_.each(k,function(b,c){if(a.match(h[c])){var d=a.split(/\//g).pop().replace(/\.[A-Za-z0-9]+$/,"");b(a,d,e)}})})};
ThreeBox.preload.html=function(a,b,c){new microAjax(a,function(b){var e;(e=b.match(/^<script[^>]*type=['"]text\/javascript['"][^>]*>([\s\S]+?)<\/script>$/m))?(b=document.createElement("script"),b.type="text/javascript",b.innerHTML=e[1],document.body.appendChild(b)):(e=document.createElement("div"),e.innerHTML=b,document.body.appendChild(e));console.log("Loaded HTML ",a);c()})};
ThreeBox.preload.image=function(a,b,c){THREE.ImageUtils.loadTexture(a,null,function(d){var e={};e[b]=d;console.log("Loaded texture ",a);c(e)})};ThreeBox.preload.audio=function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onload=function(){var e={};e[b]=d.response;console.log("Loaded audio ",a);c(e)};d.send()};(function(a){for(var b in a)if(!window[b])throw"Error: ThreeRTT requires "+a[b];})({THREE:"Three.js"});window.ThreeRTT=window.ThreeRTT||{};
ThreeRTT.World=function(){};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&b.innerText||a};_.loop=function(a,b){for(var c=0;c<a;++c)b(c)};ThreeRTT.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};ThreeRTT.isPowerOfTwo=function(a){return 0===(a&a-1)};ThreeRTT.toTarget=function(a){return ThreeRTT.Stage&&a instanceof ThreeRTT.Stage?a.target:ThreeRTT.World&&a instanceof ThreeRTT.World?a.target():a};
ThreeRTT.toTexture=function(a,b){a=ThreeRTT.toTarget(a);return ThreeRTT.RenderTarget&&a instanceof ThreeRTT.RenderTarget?a.read():a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};MicroEvent.mixin=function(a){for(var b=["bind","unbind","trigger","on","emit"],c=0;c<b.length;c++)a.prototype[b[c]]=MicroEvent.prototype[b[c]]};
ThreeRTT.Stage=function(a,b){b=_.extend({history:0,camera:{},scene:null},b);b.camera.aspect=b.camera.aspect||b.width/b.height;this.camera=ThreeRTT.Camera(b.camera);this.target=new ThreeRTT.RenderTarget(a,b);this.reset();this.size(b.width,b.height)};
ThreeRTT.Stage.prototype={options:function(){return this.target.options},reset:function(){this.scenes=[];this.passes=[]},paint:function(a,b){var c=new THREE.Scene;if(!b){var d=new ThreeRTT.FragmentMaterial(this,"generic-fragment-texture"),d=this._surface(d);c.add(d)}c.add(a);this.scenes.push(c);this.passes.push(1)},iterate:function(a,b){var c=this._surface(b),d=new THREE.Scene;d.add(c);this.scenes.push(d);this.passes.push(a);return this},fragment:function(a){this.iterate(1,a);return this},size:function(a,
b){a=Math.floor(a);b=Math.floor(b);this.camera.aspect=a/b;this.camera.updateProjectionMatrix();this.target.size(a,b);return this},read:function(a){return this.target.read(a)},uniform:function(){return this.target.uniform()},render:function(){this.target.clear();_.each(this.passes,function(a,b){_.loop(a,function(a){this.target.render(this.scenes[b],this.camera)}.bind(this))}.bind(this));return this},clear:function(){this.target.clear();return this},destroy:function(){this.target.deallocate();this.scenes=
[];this.passes=[];this.target=this.camera=null},_surface:function(a){var b=new THREE.Mesh(new ThreeRTT.ScreenGeometry,{});b.frustumCulled=!1;b.material=a;b.renderDepth=Infinity;return b}};ThreeRTT.Compose=function(a,b,c,d){THREE.Object3D.call(this);a=new ThreeRTT.FragmentMaterial(a,b,c,d);b=new ThreeRTT.ScreenGeometry;a=this.mesh=new THREE.Mesh(b,a);a.frustumCulled=!1;this.add(a)};ThreeRTT.Compose.prototype=new THREE.Object3D;
ThreeRTT.Camera=function(a){if(a instanceof THREE.Camera)return a;a=_.extend({aspect:1,far:1E4,fov:85,near:0.01,ortho:!1,scale:1},a);if(a.ortho){var b=a.scale,c=a.aspect;return new THREE.OrthographicCamera(-b*c,b*c,-b,b,a.near,a.far)}return new THREE.PerspectiveCamera(a.fov,a.aspect,a.near,a.far)};
ThreeRTT.RenderTarget=function(a,b){this.options=b=_.extend({width:256,height:256,texture:{},clear:{color:!1,depth:!1,stencil:!1},clearColor:16777215,clearAlpha:1,history:0,scene:null,camera:null,autoAdvance:!0},b);this.renderer=a;ThreeRTT.isPowerOfTwo(b.width)&&ThreeRTT.isPowerOfTwo(b.height)||b.texture.minFilter||(b.texture.minFilter=THREE.LinearFilter);this.history(this.options.history,!0);this.size(b.width,b.height);this.clear()};
ThreeRTT.RenderTarget.prototype={read:function(a){a=Math.max(0,Math.min(this.options.history,Math.abs(a||0)));return this.virtuals[a]},write:function(){return this.targets[this.index]},history:function(a,b){void 0!==a&&(this._history=a,this.buffers=a+2,b||this.allocate());return this._history},size:function(a,b){void 0!==a&&void 0!==b&&(this.width=Math.max(1,Math.floor(a)),this.height=Math.max(1,Math.floor(b)),this.allocate());return{width:this.width,height:this.height}},deallocate:function(){this.deallocateTargets()},
allocate:function(){this.deallocateTargets();this.allocateTargets();this.allocateVirtuals()},deallocateTargets:function(){_.each(this.targets||[],function(a){a.dispose()}.bind(this))},allocateTargets:function(){var a=this.options;n=this.buffers;var b=this.targets=[];_.loop(n,function(c){b.push(new THREE.WebGLRenderTarget(this.width,this.height,a.texture));b[c].__index=c}.bind(this))},allocateVirtuals:function(){var a=this.targets[0],b=this.virtuals||[];n=Math.max(1,this.buffers-1);n>b.length?_.loop(n-
b.length,function(){b.push(a.clone())}.bind(this)):b=b.slice(0,n);_.each(b,function(a,b){a.width=this.width;a.height=this.height;a.__index=b}.bind(this));this.virtuals=b;this.index=-1;this.advance()},advance:function(){var a=this.targets,b=this.virtuals,c=this.index,d=this.buffers,e=b.length;this.index=c=(c+1)%d;_.loop(e,function(f){var h=b[f];f=a[(e-f+c)%d];h.__webglTexture=f.__webglTexture;h.__webglFramebuffer=f.__webglFramebuffer;h.__webglRenderbuffer=f.__webglRenderbuffer;h.__index=f.__index})},
clear:function(){var a=this.options,b=a.clear,c=this.renderer,d=c.getClearColor().clone(),e=c.getClearAlpha();c.setClearColor(a.clearColor,a.clearAlpha);c.clearTarget(this.write(),b.color,b.depth,b.stencil);c.setClearColor(d,e)},render:function(a,b){this.emit("render",a,b);var c=this.renderer.autoClear;this.renderer.autoClear=!1;this.clear();this.renderer.render(a,b,this.write());this.renderer.autoClear=c;this.options.autoAdvance&&this.advance()},uniform:function(a){var b=this.history();if(b){var c=
[];_.loop(b+1,function(a){c.push(this.read(-a))}.bind(this));return{type:"tv",value:c,count:b+1}}return{type:"t",value:a,texture:this.read(),count:1}}};MicroEvent.mixin(ThreeRTT.RenderTarget);ThreeRTT.ScreenGeometry=function(){return new THREE.PlaneGeometry(2,2,1,1)};
ThreeRTT.ShaderMaterial=function(a,b,c,d,e){if(d instanceof Array){var f={};_.each(d,function(a,b){f["texture"+(i+1)]=a});d=f}else if(d instanceof THREE.Texture||d instanceof ThreeRTT.World||d instanceof THREE.WebGLRenderTarget)d={texture1:d};a instanceof Array||(a=[a]);a=_.map(a,function(a){return ThreeRTT.toTarget(a)});e=_.extend(e||{},{sampleStep:{type:"v2",value:new THREE.Vector2}});_.each(d,function(a,b){e[b]={type:"t",value:ThreeRTT.toTexture(a)}});_.each(a,function(a,b){var c="texture"+(b+
1);a.read&&!e[c]&&(e[c]={type:"t",value:a.read()})});e.texture1&&!e.texture&&(e.texture=e.texture1);a[0].on("render",function(){var b=a[0].options.texture,c=b.wrapT,d={1E3:0,1001:1,1002:0},f=e.sampleStep.value;f.x=1/(a[0].width-(d[b.wrapS]||0));f.y=1/(a[0].height-(d[c]||0))});return new THREE.ShaderMaterial({uniforms:e,vertexShader:ThreeRTT.getShader(b||"generic-vertex"),fragmentShader:ThreeRTT.getShader(c||"generic-fragment-texture")})};
ThreeRTT.FragmentMaterial=function(a,b,c,d){a=new ThreeRTT.ShaderMaterial(a,"generic-vertex-screen",b,c,d);a.side=THREE.DoubleSide;a.depthTest=!1;a.depthWrite=!1;a.transparent=!0;a.blending=THREE.NoBlending;return a};
ThreeRTT.ScaleMaterial=function(a,b,c){var d={};a=ThreeRTT.toTarget(a);b=ThreeRTT.toTarget(b);d=_.extend(d,{sampleAlignment:{type:"v2",value:new THREE.Vector2},texture:{type:"t",value:a.read()}});b.on("render",function(){var e=a,h=b,k=h.height*c/e.height,g=d.sampleAlignment.value;g.x=h.width*c/e.width;g.y=k});var e=new THREE.ShaderMaterial({uniforms:d,vertexShader:ThreeRTT.getShader("rtt-vertex-downsample"),fragmentShader:ThreeRTT.getShader("generic-fragment-texture")});e.side=THREE.DoubleSide;e.depthTest=
!1;e.depthWrite=!1;e.transparent=!0;e.blending=THREE.NoBlending;return e};ThreeRTT.DownsampleMaterial=function(a,b){return new ThreeRTT.ScaleMaterial(a,b,2)};ThreeRTT.UpsampleMaterial=function(a,b){return new ThreeRTT.ScaleMaterial(a,b,0.5)};
ThreeRTT.RaytraceMaterial=function(a,b,c,d,e){a instanceof Array||(a=[a]);c=new ThreeRTT.ShaderMaterial(a,"raytrace-vertex-screen",c,d,e);e=_.extend(c.uniforms||{},{raytraceViewport:{type:"v2",value:new THREE.Vector2},raytracePosition:{type:"v3",value:new THREE.Vector3},raytraceMatrix:{type:"m4",value:new THREE.Matrix4}});a=ThreeRTT.toTarget(a[0]);var f=new THREE.Vector3;a.on("render",function(a){b.updateMatrixWorld();b.fov&&(a=Math.tan(b.fov*\u03c0/360),e.raytraceViewport.value.set(a*b.aspect,a));
b.matrixWorld&&(e.raytraceMatrix.value.copy(b.matrixWorld),e.raytraceMatrix.value.setPosition(f),e.raytracePosition.value.getPositionFromMatrix(b.matrixWorld))});return c};ThreeRTT.Display=function(a,b,c){a instanceof Array||(a=[a]);this.gx=b||a.length;this.gy=c||1;this.targets=a;this.n=a.length;THREE.Object3D.call(this);this.make()};
ThreeRTT.Display.prototype=_.extend(new THREE.Object3D,{make:function(){for(var a=this.n,b=this.gx,c=this.gy,d=this.targets,e=(b-1)/2,f=(c-1)/2,h=new THREE.PlaneGeometry(1,1,1,1),k=0,g=0;k<a&&g<c;++g)for(var l=0;k<a&&l<b;++l,++k){var m=new THREE.MeshBasicMaterial({color:16777215,map:ThreeRTT.toTexture(d[k]),fog:!1});m.side=THREE.DoubleSide;m=new THREE.Mesh(h,m);m.renderDepth=1E4+Math.random();this.add(m);1<b&&(m.position.x=-e+l);1<c&&(m.position.y=f-g)}}});
ThreeRTT.World=function(a,b){b=b||{};b=_.extend({autoRendering:!0,autoSize:!(b.width&&b.height),order:++ThreeRTT.World.sequence,scale:1},b);b.width=!b.autoSize&&b.width||(a._opts&&a._opts.renderW||256)/b.scale;b.height=!b.autoSize&&b.height||(a._opts&&a._opts.renderH||256)/b.scale;a.on("resize",function(a,d){b.autoSize&&(a/=b.scale,d/=b.scale,this.size(a,d))}.bind(this));this._options=b;this._world=a;this._autoRendering=b.autoRendering;this._renderer=a.tRenderer();this._stage=new ThreeRTT.Stage(this._renderer,
b);this._tScene=this._stage.scene;this._tCamera=this._stage.camera;this.queue=ThreeRTT.RenderQueue.bind(a);b.autoRendering&&this.queue.add(this);this.size(b.width,b.height,!0)};ThreeRTT.World.sequence=1E5;
ThreeRTT.World.prototype=_.extend(new THREE.Object3D,tQuery.World.prototype,{stage:function(){return this._stage},target:function(){return this._stage.target},autoSize:function(a){void 0!==a&&(this._options.autoSize=a);return this._options.autoSize},adjust:function(a){var b=this._options.scale,c=this._options.width,d=this._options.height;this._options.autoSize&&(d=this._world._opts,c=d.renderW,d=d.renderH);c/=b;d/=b;this._opts={renderW:c,renderH:d};a||this._stage.size(c,d)},scale:function(a){return a?
(this._options.scale=a,this.adjust(),this):this._options.scale},size:function(a,b,c){return a&&b?(this._options.width=a,this._options.height=b,this.adjust(c),this):{width:this._options.width,height:this._options.height}},options:function(){return this._stage.options()},reset:function(){this._stage.reset();return this},paint:function(a,b){this._stage.paint(a,b);return this},iterate:function(a,b,c,d){b=b instanceof THREE.Material?b:tQuery.createFragmentMaterial(this,b,c,d);this._stage.iterate(a,b);
return this},shader:function(a,b,c,d){a=a instanceof THREE.Material?a:tQuery.createShaderMaterial(this,a,b,c,d);this._stage.fragment(a);return this},fragment:function(a,b,c){a=a instanceof THREE.Material?a:tQuery.createFragmentMaterial(this,a,b,c);this._stage.fragment(a);return this},raytrace:function(a,b,c,d){a=b instanceof THREE.Material?b:tQuery.createRaytraceMaterial(this,a,b,c,d);this._stage.fragment(a);return this},downsample:function(a){if(!a.autoSize()){var b=a.size();this._options.width=
b.width;this._options.height=b.height}b=a.scale();this.scale(2*b);a=tQuery.createDownsampleMaterial(a,this);this._stage.fragment(a);return this},upsample:function(a){if(!a.autoSize()){var b=a.size();this._options.width=b.width;this._options.height=b.height}b=a.scale();this.scale(0.5*b);a=tQuery.createUpsampleMaterial(a,this);this._stage.fragment(a);return this},read:function(a){return this._stage.read(a)},uniform:function(){return this._stage.uniform()},render:function(){this._stage.render();return this},
destroy:function(){this._stage.destroy();this._stage=null;this.queue.remove(this);this.trigger("destroy");return this}});tQuery.pluginsInstanceOn(ThreeRTT.World);tQuery.MicroeventMixin(ThreeRTT.World.prototype);ThreeRTT.RenderQueue=function(a){this.world=a;this.queue=[];this.callback=null;this.renderer=a.tRenderer()};
ThreeRTT.RenderQueue.prototype={add:function(a){this.queue.push(a);this.sort();this.init()},remove:function(a){this.queue.splice(this.queue.indexOf(a),1);this.cleanup()},init:function(){var a=this.queue,b=this.world;a.length&&!this.callback&&b.loop().hookPreRender(this.callback=function(){_.each(a,function(a){a.render()})})},cleanup:function(){var a=this.world;!this.queue.length&&this.callback&&(a.loop().unhookPreRender(this.callback),this.callback=null)},sort:function(){this.queue.sort(function(a,
b){return a.order-b.order})}};ThreeRTT.RenderQueue.bind=function(a){return a.__rttRenderQueue?a.__rttRenderQueue:a.__rttRenderQueue=new ThreeRTT.RenderQueue(a)};tQuery.World.registerInstance("rtt",function(a){return tQuery.createRTT(this,a)});tQuery.World.registerInstance("compose",function(a,b,c,d){a=tQuery.createComposeRTT(a,b,c,d);this.add(a);return a});tQuery.World.registerInstance("display",function(a,b,c){a=tQuery.createDisplayRTT(a,b,c);this.add(a);return a});
tQuery.registerStatic("createRTT",function(a,b){return new ThreeRTT.World(a,b)});tQuery.registerStatic("createComposeRTT",function(a,b,c,d){return new ThreeRTT.Compose(a,b,c,d)});tQuery.registerStatic("createDisplayRTT",function(a,b,c){return new ThreeRTT.Display(a,b,c)});tQuery.registerStatic("createShaderMaterial",function(a,b,c,d,e){return new ThreeRTT.FragmentMaterial(a,b,c,d,e)});tQuery.registerStatic("createFragmentMaterial",function(a,b,c,d){return new ThreeRTT.FragmentMaterial(a,b,c,d)});
tQuery.registerStatic("createRaytraceMaterial",function(a,b,c,d,e){return new ThreeRTT.RaytraceMaterial(a,b,c,d,e)});tQuery.registerStatic("createDownsampleMaterial",function(a,b){return new ThreeRTT.DownsampleMaterial(a,b)});tQuery.registerStatic("createUpsampleMaterial",function(a,b){return new ThreeRTT.UpsampleMaterial(a,b)});tQuery.registerStatic("createScaleMaterial",function(a,b,c){return new ThreeRTT.DownsampleMaterial(a,b,c)});
(function(a){for(var b in a)if(!window[b])throw"Error: ShaderGraph requires "+a[b];})({THREE:"Three.js"});window.ShaderGraph={};ShaderGraph.getShader=function(a){var b=document.getElementById(a);return b&&(b.innerText||b.textContent)||a};
(function(a){a.Block=function(b){b=b||new a.Node;this.node(b);this.children=[];this.parent=null;this.properties={};this.index=++a.Block.index;this.refresh()};a.Block.index=0;a.Block.prototype={node:function(a){return void 0!==a?(this._node=a,this):this._node},refresh:function(){this._node.owner(this);this._node.outlets(this.outlets())},fetch:function(a,c,d,e){},id:function(b,c,d,e){if(d.meta.inout){var f=d.node.get(d.name,a.IN).input;if(f)return f.node.owner().fetch(b,c,f,e+1)}return d.id()}};a.Block.Snippet=
function(b){this.snippet=new a.Snippet(b);a.Block.call(this)};a.Block.Snippet.prototype=_.extend({},a.Block.prototype,{insert:function(b,c,d){a.Block.Snippet.compileCall(b,c,this.node(),this.snippet,d)},fetch:function(a,c,d,e){a.include(this,c)||this.insert(a,c,e);return this.id(a,c,d,e)},outlets:function(){return a.Block.Snippet.makeOutlets(this.snippet)}});a.Block.Material=function(b,c){this.vertex=new a.Snippet(b);this.fragment=new a.Snippet(c);a.Block.call(this)};a.Block.Material.prototype=_.extend({},
a.Block.prototype,{compile:function(){if(0<this.node().outputs.length)throw"Can't compile material with outputs";this.node();var b=new a.Program;this.insert(b,"vertex",0);this.insert(b,"fragment",0);b.compile();return b},insert:function(b,c,d){a.Block.Snippet.compileCall(b,c,this.node(),this[c],d)},fetch:function(a,c,d,e){a.include(this,c)||this.insert(a,c,e);"fragment"==c&&(a.include(this,"vertex")||this.insert(a,"vertex",0));return this.id(a,c,d,e)},outlets:function(){var b=a.Block.Snippet.makeOutlets(this.vertex),
c=a.Block.Snippet.makeOutlets(this.fragment);return _.union(b,c)}});a.Block.Snippet.makeOutlets=function(b){var c=[];if(b.outlets)return b.outlets;var d=b.arguments();_.each(d.parameters,function(b){b=_.extend({},b);b.meta={required:!0};b.hint=b.name.replace(/(In|Out)$/,"");b.category="parameter";if(b.inout==a.INOUT){b.meta.inout=!0;var d=_.extend({},b);d.inout=a.IN;c.push(d);b.inout=a.OUT}c.push(b)});_.each(d.uniforms,function(b){b.meta={};b.hint=b.name.replace(/(In|Out)$/,"");b.category="uniform";
b.inout=a.IN;c.push(b)});return b.outlets=c};a.Block.Snippet.compileCall=function(b,c,d,e,f){var h=e.arguments(),k=[];_.each(h.parameters,function(e){var g=d.get(e.name,e.inout==a.INOUT?a.IN:e.inout);if(e.inout==a.IN||e.inout==a.INOUT)if(g.input)g=g.input.node.owner().fetch(b,c,g.input,f+1),b.variable(c,g,e),k.push(g);else throw console.log("Outlet",e,input),["Missing connection on outlet for "+e.name];else e.inout==a.OUT&&(g=g.id(),b.variable(c,g,e),k.push(g))});var g=[];_.each(h.uniforms,function(a){var e=
d.get(a.name);e.input?(e=e.input.node.owner().fetch(b,c,e.input,f+1),b.variable(c,e,a),k.push(e),g.push(a.name)):b.external("uniform",a)});_.each(h.attributes,function(a){b.external("attribute",a)});_.each(h.varyings,function(a){b.external("varying",a)});h=["_sg",c,e.name,d.owner().index].join("_");e=e.compile(h,g,!0);b.add(c,h,k,e,f)}})(ShaderGraph);
(function(a){a.Factory=function(){this.end()};a.Factory.prototype={snippet:function(b,c){c=c||"append";var d=new a.Block.Snippet(ShaderGraph.getShader(b));this[c](d.node());return this},material:function(b,c,d){d=d||"append";b=new a.Block.Material(ShaderGraph.getShader(b),ShaderGraph.getShader(c));this[d](b.node());return this},snippetBefore:function(a){this.snippet(a,"prepend");return this},materialBefore:function(a,c){this.material(code,"prepend");return this},append:function(a){a.graph||this.graph.add(a);
var c=this.stack[0];_.each(c.end,function(c){c.connect(a)});c.start.length||(c.start=[a]);c.end=[a];return this},prepend:function(a){a.graph||this.graph.add(a);var c=this.stack[0];_.each(c.start,function(c){a.connect(c)});c.end.length||(c.end=[a]);c.start=[a];return this},group:function(){this.stack.unshift({start:[],end:[]});this.stack.unshift({start:[],end:[]});return this},pass:function(){this.next();this.stack[0].start.push(null);return this.combine()},next:function(){var a=this.stack.shift(),
c=this.stack[0];c.start=c.start.concat(a.start);c.end=c.end.concat(a.end);this.stack.unshift({start:[],end:[]});return this},combine:function(){if(2>=this.stack.length)throw"Popping factory stack too far.";this.next();this.stack.shift();var a=this.stack.shift(),c=this.stack[0];a.start.length&&(_.each(a.start,function(d){d?_.each(c.end,function(a){a.connect(d,!0)}):a.end=a.end.concat(c.end)}),c.end=a.end);return this},end:function(){var b=this.graph;this.graph=new a.Graph;this.stack=[];this.group();
b&&(b.compile=function(){return b.tail().owner().compile()});return b}}})(ShaderGraph);
(function(a){a.Program=function(){this.calls={vertex:{},fragment:{}};this.variables={vertex:{},fragment:{}};this.externals={};this.compiled=!1;this.attributes={};this.uniforms={};this.fragmentShader=this.vertexShader="";this.includes={vertex:[],fragment:[]}};a.Program.types={f:"float",v2:"vec2",v3:"vec3",v4:"vec4",m3:"mat3",m4:"mat4",t:"sampler2D"};a.Program.prototype={include:function(a,c){if(0<=this.includes[c].indexOf(a))return!0;this.includes[c].push(a);return!1},external:function(a,c){c=_.extend({category:a},
c);this.externals[c.name]=c},variable:function(a,c,d){d=_.extend({},d,{name:c});this.variables[a][c]=d},add:function(a,c,d,e,f){var h=this.calls[a][c];h?h.priority=Math.min(h.priority,f):this.calls[a][c]={name:c,args:d,code:e,priority:f}},compile:function(){_.each(this.externals,function(a){"uniform"==a.category&&(this.uniforms[a.name]={type:a.type,value:a.value});"attribute"==a.category&&(this.attributes[a.name]={type:a.type,value:[]})}.bind(this));_.each(["vertex","fragment"],function(b){var c=
[];_.each(this.externals,function(a){"attribute"==a.category&&"fragment"==b||c.push([a.category,a.signature,";"].join(" "))}.bind(this));var c=c.join("\n"),d=_.toArray(this.calls[b]),e=[c],f=["void main() {"];_.each(this.variables[b],function(b){f.push([a.Program.types[b.type],b.name,";"].join(" "))});d.sort(function(a,b){return b.priority-a.priority});_.each(d,function(a){e.push(a.code);f.push([a.name,"(",a.args.join(","),");"].join(""))});f.push("}");this[b+"Shader"]=[e.join("\n"),f.join("\n")].join("\n")}.bind(this));
this.compiled=!0},material:function(){if(!this.compiled)throw"Fetching material from uncompiled program.";return new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:this.vertex,fragmentShader:this.fragment})}}})(ShaderGraph);
(function(a){a.Snippet=function(b){if(a.Snippet.cache[b])return a.Snippet.cache[b];a.Snippet.cache[b]=this;this.code=b;this.attributes=[];this.uniforms=[];this.varyings=[];this.parameters=[];this.body=this.signature="";this.parseCode(b)};a.Snippet.cache={};a.Snippet.types={"float":"f",vec2:"v2",vec3:"v3",vec4:"v4",mat3:"m3",mat4:"m4",sampler2D:"t",samplerCube:"t"};a.Snippet.defaults={"float":0,vec2:new THREE.Vector3,vec3:new THREE.Vector3,vec4:new THREE.Vector4,mat4:new THREE.Matrix4,sampler2D:0,
samplerCube:0};a.Snippet.prototype={compile:function(a,c,d){var e=this.signature.slice(),f=[];c=c||[];_.each(this.uniforms,function(a){0<=c.indexOf(a.name)?e.push(a.signature):d||f.push(["uniform",a.signature].join(" "))});!d&&_.each(this.attributes,function(a){f.push(["attribute",a.signature].join(" "))});!d&&_.each(this.varyings,function(a){f.push(["varying",a.signature].join(" "))});a=this.body.replace(/\s*void\s+([A-Za-z0-9]+)\s*\([^\)]*\)/g,["void",a+"(",e.join(", "),")"].join(" "));f.push(a);
return f.join(";\n")},arguments:function(){return{uniforms:this.uniforms,varyings:this.varyings,attributes:this.attributes,parameters:this.parameters}},type:function(b,c){b=(a.Snippet.types[b]||"f")+(c?"v":"");return"fv"==b?"fv1":b},parseAttribute:function(a){var c=a[1];this.attributes.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseUniform:function(b){var c=b[1],d=b[2];this.uniforms.push({name:b[3],type:this.type(d,b[4]),value:a.Snippet.defaults[d]||0,signature:c})},parseVarying:function(a){var c=
a[1];this.varyings.push({name:a[3],type:this.type(a[2],a[4]),signature:c})},parseSignature:function(b){this.name=b[1];var c=b[2].replace(/^\s*$/g,"");0==c.length?this.signature=[]:(arguments=this.signature=c.split(","),_.each(arguments,function(b){b=/((?:(in|out|inout)\s+)?([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/.exec(b);var c=b[1];this.parameters.push({inout:{"in":a.IN,out:a.OUT,inout:a.INOUT}[b[2]||"in"],name:b[4],type:this.type(b[3],b[5]),signature:c})}.bind(this)))},parseCode:function(a){function c(a,
b){if(!a.global)throw"Can't findAll non-global regexp";for(var c,d=[];c=a.exec(b);)d.push(c);return d}a=a.replace(/\r\n?/g,"\n").replace(/\/\/[^\n]*\n/g," ").replace(/\/\*(.|\n)*?\*\//g," ");var d=c(/(?:^|;)\s*attribute\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),e=c(/(?:^|;)\s*uniform\s+(([A-Za-z0-9]+)\s+([A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),f=c(/(?:^|;)\s*varying\s+(([A-Za-z0-9]+)\s+([[A-Za-z0-9_]+)\s*(?:\[([^\]]+)\])?)(?:$|(?=;))/g,a),h=c(/(?:^|;)\s*void\s+([A-Za-z0-9]+)\s*\(([^\)]*)\)\s*{/g,
a);if(!h[0])throw"Could not parse shader snippet. Must contain a void-returning function with in/outs: "+a;var k=a;_.each({parseAttribute:d,parseUniform:e,parseVarying:f},function(a,b){_.each(a,function(a){this[b](a);k=k.replace(a[0],"")}.bind(this))}.bind(this));k=k.replace(/^\s*;/,"");this.parseSignature(h[0]);this.body=k}}})(ShaderGraph);
(function(a){a.Graph=function(a,c){this.parent=c||null;this.nodes=[];a&&this.add(a)};a.Graph.prototype={iterate:function(a){_.each(this.nodes,function(c){a(c,c._owner)})},exposed:function(){var a=[];this.iterate(function(c){_.each(c.outlets(),function(c){c.exposed&&a.push(c)})});return a},inputs:function(){var a=[];this.iterate(function(c){_.each(c.inputs,function(c){null==c.input&&a.push(c)})});return a},outputs:function(){var a=[];this.iterate(function(c){_.each(c.outputs,function(c){0==c.output.length&&
a.push(c)})});return a},tail:function(){return this.nodes[this.nodes.length-1]},add:function(a){if(a.constructor==Array)return _.each(a,function(a){this.add(a)}.bind(this));if(a.graph)throw"Adding node to two graphs at once";a.link(this);this.nodes.push(a)},remove:function(a,c){var d=this;if(a.constructor==Array)return _.each(a,function(a){d.remove(a)});if(a.graph!=this)throw"Removing node from wrong graph.";c||a.disconnect();this.nodes.splice(this.nodes.indexOf(a),1)}};a.IN=0;a.OUT=1;a.INOUT=2})(ShaderGraph);
(function(a){a.Node=function(a,c){this.graph=null;this.inputs=[];this.outputs=[];this._outlets={};this.owner(a);this.outlets(c)};a.Node.prototype={owner:function(a){return void 0!==a?(this._owner=a,this):this._owner},link:function(a){this.graph=a},getIn:function(b){return this.get(b,a.IN)},getOut:function(b){return this.get(b,a.OUT)},get:function(b,c){return void 0===c?this.get(b,a.IN)||this.get(b,a.OUT):this._outlets[[b,c].join("-")]},key:function(a){return[a.name,a.inout].join("-")},outlets:function(b){if(void 0!==
b){var c={};_.each(b,function(a){c[[a.name,a.inout,a.type].join("-")]=!0}.bind(this));_.each(this._outlets,function(a){c[[a.name,a.inout,a.type].join("-")]||this.remove(a)}.bind(this));_.each(b,function(b){var c=this.get(b.name,b.inout);c?c.morph(b):(b=new a.Outlet(b),this.add(b))}.bind(this));return this}return this._outlets},add:function(b){var c=this.key(b);outlets=this._outlets;_in=this.inputs;_out=this.outputs;if(b.node)throw"Adding outlet to two nodes at once.";if(outlets[c])throw"Adding two identical outlets to same node.";
b.link(this);outlets[c]=b;(b.inout==a.IN?_in:_out).push(b);return this},remove:function(b){var c=this._outlets,d=this.key(b),e=b.inout==a.IN?this.inputs:this.outputs;if(b.node!=this)throw"Removing outlet from wrong node.";b.disconnect();b.link(null);delete c[d];e.splice(e.indexOf(b),1);return this},connect:function(a,c,d){var e={},f={};_.each(a.inputs,function(a){if(d||!a.input){var b=a.type,c=[b,a.hint].join("-");f[c]||(f[c]=a);e[b]=e[b]||[];e[b].push(a)}});_.each(this.outputs,function(a){if(!c||
!a.output.length){var b=a.type,d=[b,a.hint].join("-");f[d]?(f[d].connect(a),delete f[d],e[b].splice(e[b].indexOf(a),1)):e[b]&&e[b].length&&e[b].shift().connect(a)}});return this},disconnect:function(a){_.each(this.inputs,function(a){a.disconnect()});_.each(this.outputs,function(a){a.disconnect()});return this}}})(ShaderGraph);
(function(a){a.Outlets=0;a.Outlet=function(b,c,d,e,f,h,k){if("object"==typeof b)return new a.Outlet(b.inout,b.name,b.hint,b.type,b.category,b.exposed,b.meta);this.node=null;this.inout=b;this.name=c;this.hint=d||c;this.type=e;this.category=f;this.exposed=!!h;this.meta=k||{};this.index=++a.Outlets;this.input=this.key=null;this.output=[]};a.Outlet.prototype={id:function(){return["_sg",this.name,this.index].join("_")},expose:function(a){this.exposed=a},morph:function(a){this.inout=a.inout;this.name=a.name;
this.type=a.type;this.category=a.category;this.exposed=a.exposed;this.meta=a.meta||{}},connect:function(b){if(this.inout==a.IN&&b.inout==a.OUT)return b.connect(this);if(this.inout!=a.OUT||b.inout!=a.IN)throw console.log(this,b),"Can't connect out/out or in/in outlets.";b.input!=this&&(b.disconnect(),b.input=this,this.output.push(b))},disconnect:function(b){if(this.inout==a.IN)this.input&&this.input.disconnect(this);else if(b){var c=this.output.indexOf(b);0<=c&&(this.output.splice(c,1),b.input=null)}else _.each(this.output,
function(a){a.input=null}),this.output=[]},link:function(a){this.node=a}}})(ShaderGraph);\u03c0=Math.PI;\u03c4=2*\u03c0;(function(a){for(var b in a)if(!window[b])throw"Error: MathBox requires "+a[b];})({THREE:"Three.js",tQuery:"tQuery.js (bundle)",ThreeBox:"ThreeBox.js",ThreeRTT:"ThreeRTT.js"});window.MathBox={};window.mathBox=function(a,b){!a||a instanceof Node||(b=a,a=null);return tQuery.createWorld(b).mathBox(a,b)};
MathBox.getShader=function(a){var b=document.getElementById(a);return b&&b.textContent||a};Math.sign=function(a){return 0<a?1:0>a?-1:0};MathBox.Attributes=function(){};
MathBox.Attributes.prototype={get:function(a){return void 0===a?this.__attributes||{}:this.__attributes?this.__attributes[a]:void 0},set:function(a,b){function c(a,b){try{b=k(a,b),d[a]=b,f[a]=b}catch(c){throw"Exception setting '"+a+"' to '"+b+"': "+c;}}this.__attributes||(this.__attributes={});this.__validators||(this.__validators={});var d={},e=this.__validators,f=this.__attributes,h=this,k=function(a,b){if(void 0===e[a]){var c="validate"+a.charAt(0).toUpperCase()+a.slice(1);e[a]=h[c]||!1}return e[a]?
e[a].call(this,b):b}.bind(this);void 0!==a&&null!==a&&(a.constructor==String?c(a,b):_.each(a,function(a,b){c(b,a)}),this.emit("change",d))}};MicroEvent.mixin(MathBox.Attributes);MathBox.Attributes.mixin=function(a){_.each(["get","set","on","emit"],function(b){a.prototype[b]=MathBox.Attributes.prototype[b]})};MathBox.Animator=function(){this.active=[]};MathBox.Animator.now=1;
MathBox.Animator.prototype={finalState:function(a){var b=_.extend({},a.get());a.__queue&&_.each(a.__queue,function(a,d){_.each(a,function(a){a.to&&(b[d]=a.to)})});return b},attach:function(a){if(!a.__queue){if(!a.__attributes)throw"Cannot attach to object without attributes";var b=this,c=a.set;a.set=function(a,e,f){if(!f){f=a;if(void 0===a||null===a)return;a.constructor==String&&(f={},f[a]=e);b.stop(this,f)}c.call(this,a,e)};a.__queue={};a.__animations=0}},hurry:function(a,b,c){c=c||4;_.each(b||a.__queue,
function(b,e){_.each(a.__queue[e],function(a){a.hurry(c)})}.bind(this))},stop:function(a,b){_.each(b||a.__queue,function(b,d){for(;a.__queue[d];)this.dequeue(a,d,!0)}.bind(this))},animate:function(a,b,c){c=_.extend({duration:300},c||{});this.attach(a);_.each(b,function(b,e){var f=a.__queue[e]=a.__queue[e]||[];if(c.delay){var h=new MathBox.Animator.Delay(a,e,c.delay);f.push(h);0==a.__animations++&&this.active.push(a)}a.__validators[e]&&(b=a.__validators[e].call(a,b));h=new MathBox.Animator.Animation(a,
e,b,c.duration,c.callback,c.ease);f.push(h);c.hold&&(h=new MathBox.Animator.Delay(a,e,c.hold),f.push(h),0==a.__animations++&&this.active.push(a));0==a.__animations++&&this.active.push(a)}.bind(this))},dequeue:function(a,b,c){var d=a.__queue[b];if(d){var e=d.shift();0==d.length&&delete a.__queue[b];c&&e.skip();0==--a.__animations&&this.active.splice(this.active.indexOf(a),1)}},update:function(a){MathBox.Animator.now+=a;a=this.active.slice();_.each(a,function(a){var c=0;_.each(a.__queue,function e(f,
h){var k=f[0];value=k.apply(c||0);k.done()&&(c=k.extra(),this.dequeue(a,h),f[0]&&e.call(this,f,h))}.bind(this))}.bind(this))}};MathBox.Animator.Delay=function(a,b,c){this.object=a;this.key=b;this.duration=c;this.fraction=this.start=0};
MathBox.Animator.Delay.prototype={init:function(a){this.start=MathBox.Animator.now-(a||0)},apply:function(a){this.start||this.init(a);this.fraction=0<this.duration?Math.min(1,(MathBox.Animator.now-this.start)/this.duration):1},skip:function(){this.duration=0},hurry:function(a){this.duration=this.duration*this.fraction+this.duration*(1-this.fraction)/a},extra:function(){return MathBox.Animator.now-this.start-this.duration},done:function(){return 1==this.fraction}};
MathBox.Animator.Animation=function(a,b,c,d,e,f){this.object=a;this.key=b;this.from=null;this.to=c;this.duration=d;this.fraction=this.start=0;this.callback=e;this.ease=f};
MathBox.Animator.Animation.prototype={init:function(a){this.start=MathBox.Animator.now-(a||0);null===this.from&&(this.from=this.object.get(this.key));void 0===this.from&&(this.from=0)},apply:function(a){function b(a,b){return a+(b-a)*g}function c(a,e){void 0===e&&(e=a);void 0===a&&(a=e);if(e===a)return a;if(typeof a!=typeof e)throw console.log(d,f),"Data type mismatch between from/to values in animator. "+f+": "+a+" ("+a.constructor+"), "+e+"("+e.constructor+")";var g;switch(typeof e){default:case "string":throw"Unimplemented value type in animator. ("+
typeof e+")";case "function":return function(){return c(a.apply(this,arguments),e.apply(this,arguments))};case "boolean":return 0.5<k?e:a;case "number":return b(a,e);case "object":if(!a)return e;if(!e)return a;if(e.constructor==Array)return g=[],_.loop(a.length,function(b){g[b]=c(a[b],e[b])}),g;if(e.constructor==THREE.Matrix4){g=new THREE.Matrix4;for(var h=0;16>h;++h)g.elements[h]=b(a.elements[h],e.elements[h]);return g}return e.constructor==THREE.Vector3?(g=new THREE.Vector3,g.x=b(a.x,e.x),g.y=b(a.y,
e.y),g.z=b(a.z,e.z),g):e.constructor==THREE.Color?(g=new THREE.Color,g.r=b(a.r,e.r),g.g=b(a.g,e.g),g.b=b(a.b,e.b),g):0.5<k?e:a}}this.start||this.init(a);var d=this.object;a=this.from;var e=this.to,f=this.key,h=this.ease,k;this.fraction=k=0<this.duration?Math.min(1,(MathBox.Animator.now-this.start)/(this.duration||1)):1;var g;switch(h){case "in":g=1-(1-k)*(1-k);break;case "out":g=k*k;break;case "linear":g=k;break;default:g=0.5-0.5*Math.cos(k*\u03c0)}a=c(a,e);this.object.set(this.key,a,!0)},hurry:function(a){this.duration=
this.duration*this.fraction+this.duration*(1-this.fraction)/a},skip:function(){this.duration=0;this.fraction=1;this.done()},extra:function(){return MathBox.Animator.now-this.start-this.duration},done:function(){return 1==this.fraction?(this.object.set(this.key,this.to,!0),this.callback&&this.callback(),this.callback=null,!0):!1}};
MathBox.Stage=function(a,b,c){this.options=a=a||{};this._world=b;this.overlay=c;b&&b.on("resize",function(a,b){this.overlay.size(a,b);this.width=a;this.height=b}.bind(this));this.primitives=[];this.materials=new MathBox.Materials(this);this.animator=new MathBox.Animator;this._transition=0;this._speed=1;b&&(this.cameraProxy=new MathBox.CameraProxy(b,this.options));this.viewport({});this.loadPrimitives();void 0!==a.transition&&this.transition(a.transition);void 0!==a.speed&&this.speed(a.speed)};
MathBox.Stage.prototype=new THREE.Object3D;MathBox.Attributes.mixin(MathBox.Stage);MicroEvent.mixin(MathBox.Stage);
MathBox.Stage.prototype=_.extend(MathBox.Stage.prototype,{update:function(){var a=this._viewport,b=this._world.tCamera(),c=this.width,d=this.height,e=this._speed;this.cameraProxy.update();var f=+new Date;this.last||(this.last=f-1E3/60);this.animator.update(e*(f-this.last));this.last=f;a.update(this);_.each(this.primitives,function(e){e.adjust(a,b,c,d,this);e=e.renderables();_.each(e,function(e){e.isVisible()&&e.adjust(a,b,c,d,this)}.bind(this))}.bind(this));this.overlay&&this.overlay.update(b)},add:function(a,
b){if(a instanceof THREE.Object3D)return a instanceof MathBox.Sprite?this.overlay.add(a):THREE.Object3D.prototype.add.call(this,a);this._add(a);b=this.animateOptions(b);var c=a.style.get("opacity");b&&0<c&&(a.style.set("opacity",0),this.animator.animate(a.style,{opacity:c},b));return this},remove:function(a,b){if(a instanceof THREE.Object3D)return a instanceof MathBox.Sprite?this.overlay.remove(a):THREE.Object3D.prototype.remove.call(this,a);if("string"==typeof a)return _.each(this.select(a),function(a){this.remove(a,
b)}.bind(this));if(!a.singleton){var c=function(){this._remove(a)}.bind(this);b=this.animateOptions(b);var d=a.style.get("opacity");b&&0<d?(b.callback=c,this.animator.animate(a.style,{opacity:0},b),a.removed=!0):c();return this}},_add:function(a){var b=this.materials;-1==this.primitives.indexOf(a)&&(this.primitives.push(a),a.make(),a=a.renderables(),_.each(a,function(a){a.make(b);a.object&&this.add(a.object)}.bind(this)))},_remove:function(a){if(-1!=this.primitives.indexOf(a)){this.primitives.splice(this.primitives.indexOf(a),
1);var b=a.renderables();_.each(b,function(a){a.object&&this.remove(a.object);a.destroy()}.bind(this));a.destroy()}},select:function(a,b){var c=[];if("object"==typeof a)return a.constructor==Array?a:[a];var d=function(a){var c=[];if("*"==a)return c=this.primitives.slice(),c.push(this.viewport()),c.push(this.cameraProxy),c;if(a==+a)return _.each(this.primitives,function(d){!b&&d.removed||d.get("sequence")!=a||c.push(d)}),c;var d=a.match(/^\s*#([a-zA-Z0-9_-]+)|([a-zA-Z0-9_-]+)?\s*$/);if(!d)return[];
var k=d[2],g=d[1];if(g)_.each(this.primitives,function(a){!b&&a.removed||a.get("id")!=g||c.push(a)});else{if("camera"==k)return this.cameraProxy&&[this.cameraProxy]||[];if("viewport"==k)return[this.viewport()];k&&_.each(this.primitives,function(a){!b&&a.removed||a.type()!=k||c.push(a)})}return c}.bind(this),c=[];a=(""+a).split(",");_.each(a,function(a){c=c.concat(d(a))});return c},set:function(a,b){b=this.extractStyle(b);_.each(this.select(a),function(a){a.set(b);b.style&&a.style.set(b.style)});return this},
get:function(a){var b=this.animator;a=this.select(a);if(1>a.length)return{};var c=a[0];a=b.finalState(c);c.style&&(b=b.finalState(c.style),a.style=b);return a},transition:function(a){return void 0!==a?(this._transition=a,this):this._transition},speed:function(a){return void 0!==a?(this._speed=a,this):this._speed},animateOptions:function(a,b){var c=this._transition;!0===a&&(a={});if(c||b||a&&(a.delay||a.duration||a.hold))a=_.extend({delay:0,duration:c||0,hold:0},a||{});if(a&&(a.delay||a.duration||
a.hold))return a},animate:function(a,b,c){var d=this.animator;b=this.extractStyle(b);c=this.animateOptions(c,!0);b.style&&(_.each(this.select(a),function(a){c?d.animate(a.style,b.style,c):a.style.set(b.style)}),b=_.extend({},b),delete b.style);_.each(this.select(a),function(a){c?d.animate(a,b,c):a.set(b)});return this},clone:function(a,b,c){_.each(this.select(a),function(a){var e=this.get(a);delete e.sequence;var f=_.extend({},b),h=[];_.each(b,function(a,c){if("id"==c||"boolean"==typeof a||null===
a)e[c]=b[c],h.push(c)});_.each(h,function(a){delete f[a]});e.id==a.get("id")&&(e.id=(e.id||"")+"-clone");a=this.spawn(a.type(),e,{duration:0});this.animate(a,f,c)}.bind(this));return this},hurry:function(a,b,c){var d=this.animator;_.each(this.select(a,!0),function(a){d.hurry(a,b,c);a.style&&d.hurry(a.style,b,c)});return this},halt:function(a,b){var c=this.animator;_.each(this.select(a,!0),function(a){c.stop(a,b);a.style&&c.stop(a.style,b)});return this},viewport:function(a){if(void 0!==a){if(!this._viewport||
a.type&&a.type!=this.options.viewport.type){this._viewport&&(a=_.extend({},this._viewport.get(),a));this._viewport=MathBox.Viewport.make(a);a=this.primitives.slice();var b=this;_.each(a,function(a){b._remove(a);b._add(a)})}else this._viewport.set(a);this.options.viewport=this._viewport.get();return this}return this._viewport},camera:function(a){_.each(this.select("camera"),function(b){b.set(a)});return this},start:function(){this._world&&this._world.start();return this},stop:function(){this._world&&
this._world.stop();return this},world:function(){return this._world},extractStyle:function(a){var b=MathBox.Style.prototype.defaults(),c=null;_.each(a,function(d,e){void 0!==b[e]&&(delete a[e],c=c||{},c[e]=d)});c&&(a.style=_.extend(a.style||{},c));return a},spawn:function(a,b,c){return MathBox.Primitive.types[a]?(this[a](b,c),this.primitives[this.primitives.length-1]):this},loadPrimitives:function(){_.each(MathBox.Primitive.types,function(a,b){this[b]=function(b,d){a.validateArgs&&(b=a.validateArgs(b));
var e=new a(this.extractStyle(b));this.add(e,d);return this}}.bind(this))}});MathBox.Materials=function(a){this.stage=a;this.cache={}};
MathBox.Materials.prototype={hash:function(a){var b=Object.keys(a),c="";b.sort();_.each(b,function(b){c+=b+"/";c+=a[b]+"/"});return c},clone:function(a){var b=new THREE.ShaderMaterial({vertexShader:a.vertexShader,fragmentShader:a.fragmentShader});b.attributes=a.attributes?{}:null;b.uniforms={};b.wireframe=a.wireframe;b.applyUniforms=a.applyUniforms;b.applyAttributes=a.applyAttributes;_.each(a.uniforms,function(a,d){b.uniforms[d]={type:a.type,value:a.value&&a.value.clone?a.value.clone():a.value}});
_.each(a.attributes,function(a,d){b.attributes[d]={type:a.type,value:a.value}});return b},generic:function(a){a=a||{};if(!a.shaders||!Object.keys(a.shaders).length){var b=this.hash(a);if(this.cache[b])return this.clone(this.cache[b])}var c=this.factory(),d=a.shaders||{};d.position?d.position(c,this):(this.position(c,a),a.absolute||(a.shaded&&a.smooth?(c.group(),this.viewport(c),c.next(),this.viewport(c),c.next(),this.viewport(c),c.combine()):this.viewport(c)));a=this.finalize(c,a);b&&(this.cache[b]=
a);return a},position:function(a,b){b=b||{};a.snippet(b.shaded&&b.smooth?"getPositionDUDV":"getPosition");b.absolute||(b.shaded&&b.smooth?a.group().snippet("mathTransform").next().snippet("mathTransform").next().snippet("mathTransform").combine():a.snippet("mathTransform"));return a},factory:function(){return new ShaderGraph.Factory},finalize:function(a,b){b=b||{};var c=b.shaders||{};b.shaded?b.smooth?a.snippet("projectToViewDUDV"):a.snippet("projectToViewNormal"):a.snippet("projectToView");c.material?
c.material(a,this):a.material("vertexOutput",{points:"fragmentSolidPoint",mesh:b.shaded?"fragmentShaded":"fragmentSolid"}[b.type]||"fragmentSolid");c=a.end().compile();c=new THREE.ShaderMaterial({uniforms:c.uniforms,attributes:c.attributes,vertexShader:c.vertexShader,fragmentShader:c.fragmentShader});b.wireframe&&(c.wireframe=!0);var d=this.apply.bind(this);c.applyUniforms=function(a){d(this,a,"uniforms")};c.applyAttributes=function(a){d(this,a,"attributes")};return c},apply:function(a,b,c){var d=
a[c];_.each(b,function(a,b){var c=d[b];c&&(a instanceof THREE.Color&&(a.x=a.r,a.y=a.g,a.z=a.b),c.value=a,c.needsUpdate=!0)});if("uniforms"==c){c=a.uniforms;if(b.map&&(c.texture&&(c.texture.value=b.map),c.offsetRepeat)){var e=b.map.offset,f=b.map.repeat;c.offsetRepeat.value.set(e.x,e.y,f.x,f.y)}void 0!==b.lineWidth&&(a.wireframeLinewidth=a.linewidth=b.lineWidth);void 0!==b.opacity&&(a.transparent=1>b.opacity)}},viewport:function(a,b){this.stage.viewport().shader(a,b)}};
MathBox.Ticks=function(a,b,c,d,e,f,h){var k=(b-a)/(c||10);d=d||1;e=e||10;var g=d*((h||0)+Math.pow(e,Math.floor(Math.log(k/d)/Math.log(e))));c=_.map(0==e%2?[e/2,1,0.5]:[1],function(a){return g*a});var l=_.reduce(c,function(a,b){return Math.abs(b-k)<Math.abs(a-k)?b:a},g);f=+!f;a=(Math.ceil(a/l)+f)*l;b=(Math.floor(b/l)-f)*l;c=Math.ceil((b-a)/l)+1;var m=[];_.loop(c,function(b){m.push(a+b*l)});return m};MathBox.TicksLog=function(a,b,c,d,e,f){};
tQuery.World.registerInstance("mathBox",function(a,b){a=a||document.body;this.threeBox(a,b);var c=new MathBox.Overlay;a.appendChild(c.domElement);c.domElement.style.position="absolute";c.domElement.style.left=0;c.domElement.style.top=0;c.domElement.style.right=0;c.domElement.style.bottom=0;var d=new MathBox.Stage(b,this,c),e=function(){d.update()};this.tScene().add(d);this._renderer.setClearColorHex(16777215,1);d.unhook=function(){this.loop().unhookPreRender(e)};this.loop().hookPreRender(e);b.cameraControls||
(c=this.tCamera(),c.position.x=0,c.position.y=0,c.position.z=b.orbit,c.lookAt(new THREE.Vector3(0,0,0)));return d});MathBox.Director=function(a,b){this._stage=a;this.script=b||[];this.rollback={};this.clocks={};this.time=this.lastCommand=this.step=0;this.lastTime=+new Date};
MathBox.Director.prototype={clock:function(a,b){if(a>this.step)return 0;var c=+new Date;this.time+=(c-this.lastTime)*this.stage().speed();this.lastTime=c;if(b||!this.clocks[a])this.clocks[a]=this.time;return 0.001*(this.time-this.clocks[a])},invert:function(a){var b=this._stage,c=[],d,e=a[0],f=a[1],h=a[2]||{},k=a[3];"remove"==e&&(k=h);k={delay:k&&void 0!==k.hold?k.hold/4:0,duration:k&&void 0!==k.duration?k.duration/4:0,hold:k&&void 0!==k.delay?k.delay/4:0};switch(e){case "add":d=[0];case "clone":d=
d||b.select(f);_.each(d,function(a,b){c.push(["remove",h.sequence||MathBox.Primitive.sequence+1+b,k])});break;case "remove":d=b.select(f);_.each(d,function(a){c.push(["add",a.type(),b.get(a),k])});break;case "animate":case "set":d=b.select(f),_.each(d,function(a){var d=b.get(a),f={};for(i in h)f[i]=d.style&&void 0!==d.style[i]?d.style[i]:d[i];c.push([e,a.singleton||a.get("sequence"),f,k])})}return c},invertDelay:function(a){function b(a){var b=a[2]||{},c=["opacity"];if("animate"==a[0])for(d in c=
[],b)if("style"==d)for(j in b.style)c.push(j);else c.push(d);return c}var c=[],d,e={};a.forEach(function(a){var c=a[0],d=a[1]||"",f=a[2]||{},h=a[3]||{};if("set"==c)return null;"add"==c&&(d=f.sequence);"remove"==c&&(h=f);b(a).forEach(function(a){a=[d,a].join(".");e[a]||(e[a]=[]);h=h||{};e[a].push((h.delay||0)+(h.duration||0)+(h.hold||0))})});var f=0;for(d in e)var h=e[d]=e[d].reduce(function(a,b){return a+b}),f=Math.max(f,h);a.forEach(function(a){var d=a[0],h=a[1]||"",m=a[2]||{},q=a[3]||{},u;if("set"==
d)return c.push(a);"add"==d&&(u=h,h=m.sequence);"remove"==d&&(q=m);b(a).forEach(function(a){var b=[h,a].join("."),k=q.delay||0,v=q.duration||0,w=q.hold||0;void 0!==e[b]&&(k+=f-e[b],delete e[b]);q={delay:k,duration:v,hold:w};"add"==d&&c.push([d,u,m,q]);"remove"==d?c.push([d,h,q]):(b={},b[a]=m.style&&void 0!==m.style[a]?m.style[a]:m[a],c.push([d,h,b,q]))})});return c},apply:function(a,b,c,d){var e=this._stage;_.each(a,function(a){var h=a[0]||"",k=a[1]||"",g=a[2]||{},l=a[3]||{};"remove"==h&&(l=g);b&&
(a=this.invert(a),a=[0,0].concat(a),Array.prototype.splice.apply(b,a));d&&l&&(l=_.extend({},l),l.delay/=2,l.duration/=2,l.hold/=2);c&&(l={delay:0,duration:0,hold:0},"animate"==h&&(h="set"));switch(h){case "clone":e.clone(k,g,l);break;case "add":e.spawn(k,g,l);break;case "remove":_.each(e.select(k),function(a){e.remove(a,l)});break;case "set":var h=e.select(k),m=g.constructor==Array;_.each(h,function(a,b){e.set(a,m?g[b]:g)});break;case "animate":h=e.select(k),m=g.constructor==Array,_.each(h,function(a,
b){e.animate(a,m?g[b]:g,l)})}}.bind(this));return this},insert:function(a){a[0].constructor!=Array&&(a=[a]);this.script.splice(this.step,0,a);this.forward();return this},is:function(a){if(!this.script.length)return!1;for(;0>a;)a+=this.script.length+1;for(;a>=this.script.length+1;)a-=this.script.length+1;return a==this.step},isFirst:function(){return this.is(0)},isLast:function(){return this.is(-1)},go:function(a,b){if(this.script.length){for(;0>a;)a+=this.script.length+1;for(;a>=this.script.length+
1;)a-=this.script.length+1;for(;a>this.step;)this.forward(b);for(;a<this.step;)this.back(b)}},skipping:function(){var a=+new Date,b=!1;500>a-this.lastCommand&&(b=!0);this.stage().hurry("*");this.lastCommand=a;return b},forward:function(a,b){if(!(this.step>=this.script.length)){var c=this.step,d=this.script[c],e=this.rollback[c]=[];this.step++;var f=function(){this.apply(d,e,a,a?!1:this.skipping());this.rollback[c]=this.invertDelay(e);this.clock(c+1,!0);this.emit("go",c+1,1)}.bind(this);b?setTimeout(f,
+b):f();return this}},back:function(a,b){if(!(0>=this.step)){this.step--;var c=this.step,d=this.rollback[c],e=function(){this.apply(d,null,a||this.skipping());delete this.rollback[c];this.emit("go",c,-1)}.bind(this);b?setTimeout(e,+b):e();return this}},stage:function(){return this._stage}};_.each(MathBox.Stage.prototype,function(a,b){MathBox.Director.prototype[b]||(MathBox.Director.prototype[b]=function(){var b=this.stage[a].apply(this.stage,arguments);return b===this.stage?this:b})});MicroEvent.mixin(MathBox.Director);
MathBox.Style=function(a){var b=this.defaults();a=_.extend(b,a||{});this.set(a)};
MathBox.Style.prototype={defaults:function(){return{color:new THREE.Color(3178736),opacity:1,lineWidth:2,pointSize:5,mathScale:new THREE.Vector3(1,1,1),mathRotation:new THREE.Vector3,mathPosition:new THREE.Vector3,worldScale:new THREE.Vector3(1,1,1),worldRotation:new THREE.Vector3,worldPosition:new THREE.Vector3,zIndex:0,map:null,mapColor:0,mapOpacity:0}},validateColor:function(a){if(a.constructor==Array){a=a.concat([0,0,0]);var b=new THREE.Color;return b.setRGB.apply(b,a)}return a.constructor==Number?
new THREE.Color(a):a.constructor!=THREE.Color?this.get("color"):a},validateMathScale:function(a){if(a.constructor==Array){a=a.concat([1,1,1]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathScale"):a},validateMathRotation:function(a){if(a.constructor==Array){a=a.concat([0,0,0]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathRotation"):a},validateMathPosition:function(a){if(a.constructor==Array){a=
a.concat([0,0,0]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("mathPosition"):a},validateWorldScale:function(a){if(a.constructor==Array){a=a.concat([1,1,1]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldScale"):a},validateWorldRotation:function(a){if(a.constructor==Array){a=a.concat([0,0,0]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldRotation"):
a},validateWorldPosition:function(a){if(a.constructor==Array){a=a.concat([0,0,0]);var b=new THREE.Vector3;return b.set.apply(b,a)}return a.constructor!=THREE.Vector3?this.get("worldPosition"):a}};MathBox.Attributes.mixin(MathBox.Style);
MathBox.CameraProxy=function(a,b){this.set({orbit:void 0===b.orbit?3.5:b.orbit,phi:void 0===b.phi?\u03c4/4:b.phi,theta:b.theta||0,lookAt:b.lookAt||[0,0,0]});this.singleton="camera";var c=this.controls=a.getCameraControls()||ThreeBox.OrbitControls.bind(a.tCamera(),null,this.get());this.on("change",function(a){_.each(a,function(a,b){"lookAt"!=b&&(c[b]=a)});a.lookAt&&c.lookAt.set.apply(c.lookAt,a.lookAt);c.update()});c.update();this.update=function(){this.set({orbit:c.orbit,phi:c.phi,theta:c.theta},
null,!0);var a=this.get("lookAt");a[0]=c.lookAt.x;a[1]=c.lookAt.y;a[2]=c.lookAt.z}};MathBox.Attributes.mixin(MathBox.CameraProxy);MathBox.Overlay=function(){(this.domElement=document.createElement("div")).className="mathbox-overlay";this.sprites=[];this.v=new THREE.Vector3;this.q=new THREE.Vector3};
MathBox.Overlay.prototype={size:function(a,b){this.width=a;this.height=b;this.domElement.style.width=a+"px";this.domElement.style.height=b+"px"},add:function(a){-1==this.sprites.indexOf(a)&&(this.sprites.push(a),a.element.parentNode||this.domElement.appendChild(a.element),_.each(a.children,function(a){this.add(a)}.bind(this)))},remove:function(a){var b;-1!=(b=this.sprites.indexOf(a))&&(this.sprites.splice(b,1),a.element.parentNode&&a.element.parentNode.removeChild(a.element),_.each(a.children,function(a){this.remove(a)}.bind(this)))},
update:function(a){this.fov=0.5/Math.tan(a.fov*Math.PI/360)*this.height;_.each(this.sprites,function(b){this._update(b,a)}.bind(this));_.each(this.sprites,function(b){this._measure(b,a)}.bind(this));_.each(this.sprites,function(b){this._vis(b,a)}.bind(this))},_measure:function(a,b){if(a.measure){var c=a.element;a.width=c.offsetWidth;a.height=c.offsetHeight;a.measure=!1}},_vis:function(a,b){if(a.render&&(a.width||a.height)){var c=a.left,d=a.top,e=a.width+c,f=a.height+d;found=!1;_.each(this.sprites,
function(b){if(b===a)found=!0;else if(found&&b.render){var k=b.left,g=b.top,l=b.width+k,m=b.height+g;e<k||c>l||f<g||d>m||(b.element.style.display="none",b.render=!1)}})}},_update:function(a,b){for(var c=this.v,d=this.q,e=a.render,f=a.visible,h=a.parent;f&&h;)f=f&&h.visible,h=h.parent;a.render=f&&0<a.opacity;if(a.render)e||(a.element.style.display="block"),c.copy(a.position),b.matrixWorldInverse.multiplyVector3(c),e=-(c.x/c.z)*this.fov+0.5*this.width,f=c.y/c.z*this.fov+0.5*this.height,a.distance&&
(d.copy(a.tangent).multiplyScalar(0.01),d.addSelf(a.position),b.matrixWorldInverse.multiplyVector3(d),h=0<a.distance?1:-1,d.subSelf(c),d.z=0,d.normalize().multiplyScalar(a.distance),e+=Math.abs(d.y)*h,f+=Math.abs(d.x)*h),e=Math.round(e),f=Math.round(f),a.left!==e&&(a.left=e,a.element.style.left=e+"px"),a.top!==f&&(a.top=f,a.element.style.top=f+"px"),a.lastOpacity!==a.opacity&&(a.element.style.opacity=a.opacity,a.lastOpacity=a.opacity);else if(e||null===e)a.element.style.display="none"}};
MathBox.Sprite=function(a,b,c){this.element=a;this.tangent=b||new THREE.Vector3(1,0,0);this.distance=c||0;this.height=this.width=0;this.measure=this.visible=!0;this.render=null;this.content="";this.lastOpacity=this.lastTop=this.lastLeft=null;a.style.position="absolute";a.style.left=0;a.style.top=0;a.style.opacity=0;THREE.Object3D.call(this)};MathBox.Sprite.prototype=_.extend(new THREE.Object3D,{});
MathBox.Primitive=function(a){if(null!==a){var b=this.defaults();a&&(a.style=_.extend(b.style,a.style||{}),a=_.extend(b,a||{}));a=a||b;this.set(a);this.style=new MathBox.Style;this.style.set(this.get().style||{});this.on("change",function(a){void 0!==a.style&&this.style.set(a.style)}.bind(this));this.set("sequence",a.sequence||++MathBox.Primitive.sequence);this.set("id",a.id||this.sequence);this.init()}};MathBox.Primitive.sequence=0;MathBox.Primitive.types={};
MathBox.Primitive.prototype={defaults:function(){return{}},type:function(){return"primitive"},init:function(){},make:function(){},destroy:function(){},renderables:function(){return[]},adjust:function(a){}};MathBox.Attributes.mixin(MathBox.Primitive);MicroEvent.mixin(MathBox.Primitive);MathBox.Curve=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Curve.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:64,domain:[0,1],data:null,expression:function(){return 0},live:!0,points:!1,line:!0,style:{}}},type:function(){return"curve"},renderables:function(){return[this.line,this.points]},adjust:function(a){a=this.get();this.line.show(a.line);this.points.show(a.points);(a.line||a.points)&&0<this.style.get("opacity")&&a.live&&this.calculate()},make:function(){var a=this.get(),b=this.style,c=a.n,d=this.vertices=[];_.loop(c,
function(){d.push(new THREE.Vector3)});c=function(c){return new MathBox.Renderable.Mesh(d,{type:c,dynamic:a.live},b)};this.line=c("line");this.points=c("points");this.calculate()},calculate:function(){var a=this.vertices,b=this.get(),c=b.data,d=b.domain,e=b.n,f=d[0],h=(d[1]-f)/(e-1),k;_.loop(e,function(d){k=c&&void 0!==c[d]?c[d]:b.expression.call(this,f,d);var e=0,m=0,q=0;if(k instanceof Array){var u=k.length;0<u&&(e=k[0]);1<u&&(m=k[1]);2<u&&(q=k[2])}else e=f,m=+k;a[d].set(e,m,q);f+=h}.bind(this))}});
MathBox.Primitive.types.curve=MathBox.Curve;MathBox.Bezier=function(a){MathBox.Curve.call(this,a)};
MathBox.Bezier.prototype=_.extend(new MathBox.Curve(null),{defaults:function(){return{n:64,domain:[0,1],data:null,order:3,expression:function(){return 0},live:!0,points:!1,line:!0,style:{}}},type:function(){return"bezier"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,e=b.order,f=b.n;if(1>e||3<e)throw"Bezier curve order must be 1, 2 or 3.";var h=[],k;_.loop(e+1,function(a){k=d&&void 0!==d[a]?d[a]:b.expression.call(this,a,a);var c=a=0,e=0;if(k instanceof Array){var f=k.length;
0<f&&(a=k[0]);1<f&&(c=k[1]);2<f&&(e=k[2])}else a=l,c=+k;h.push(new THREE.Vector3(a,c,e))}.bind(this));var g={bezierPoints:h},l=c[0],m=(c[1]-l)/(f-1);_.loop(f,function(b){a[b].set(l,0,0);l+=m});c={uniforms:g,shaders:{position:function(a,b){a.snippet("bezier"+e).snippet("mathTransform");b.viewport(a)}}};this.line.set(c);this.points.set(c)}});MathBox.Primitive.types.bezier=MathBox.Bezier;
MathBox.Axis=function(a){null!==a&&(MathBox.Primitive.call(this,a),this.on("change",function(a){void 0!==a.size&&this.arrow&&this.arrow.set("size",a.size)}))};
MathBox.Axis.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:0,offset:[0,0,0],n:2,arrow:!0,line:!0,labels:!1,decimals:2,distance:15,ticks:10,tickUnit:1,tickScale:10,size:0.07,style:{lineWidth:4,color:new THREE.Color(7368816)},formatter:null,zero:!0}},renderables:function(){return[this.line,this.ticks,this.arrow,this.labels]},type:function(){return"axis"},adjust:function(a,b){var c=this.get(),d=c.axis,e=c.offset,f=c.arrow,h=c.line,k=c.labels,g=c.n,l=c.ticks,m=c.tickUnit,
q=c.tickScale,c=c.decimals,u=this.points,t=this.labelPoints,s=this.labelTangent,r=this.tickPoints,v=this.tickSigns,w=[0,0,0],y=new THREE.Vector3;new THREE.Vector4;var x=a.axis(d),z=x[0],x=x[1],B=(x-z)/(g-1);y.set.apply(y,e);_.loop(g,function(a){w[d]=z+a*B;u[a].set.apply(u[a],w);u[a].addSelf(y)});this.line.show(h);this.arrow.show(f);g=this.scale=MathBox.Ticks(z,x,l,m,q,!0);this.ticks.show(!!l);if(l){l=Math.floor(r.length/2);g.length>l&&(g=g.slice(0,l));var l=[0,0,0],A;l[2==d?0:1-d]=0.01*(x-z);this.epsilon.set.apply(this.epsilon,
l);w=[0,0,0];_.each(g,function(a,b){w[d]=a;var c=2*b;r[c].set.apply(r[c],w);r[c].addSelf(y);v[c]=1;r[c+1].copy(r[c]);v[c+1]=-1;t[b].copy(r[c]);A=c+1});l=A+1;for(g=r.length;l<g;)r[l].copy(r[A]),v[l]=v[A],l++}w=[0,0,0];w[d]=1;s.set.apply(s,w);this.labels.show(!!k);this.labels.set("decimals",c)},make:function(){var a=this.get(),b=a.n,c=a.size,d=a.ticks,e=a.distance,f=a.formatter,h=this.style,k=this.points=[],g=this.labelPoints=[],l=this.labelTangent=new THREE.Vector3,m=this.tickPoints=[],q=this.tickSigns=
[],u=this.epsilon=new THREE.Vector3;_.loop(b,function(a){k.push(new THREE.Vector3)});_.loop(4*d,function(a){g.push(new THREE.Vector3)});_.loop(8*d,function(a){m.push(new THREE.Vector3);q.push(1)});var d={dynamic:!0,size:c,offset:0.5},c={dynamic:!0,size:0.2*c},e={dynamic:!0,distance:e},t=function(b){b=this.scale[b];return 0!=b||a.zero?f?f(b):b:""}.bind(this);this.line=new MathBox.Renderable.Mesh(k,{dynamic:!0,type:"line"},h);this.arrow=new MathBox.Renderable.ArrowHead(k[b-2],k[b-1],d,h);this.ticks=
new MathBox.Renderable.Ticks(m,q,u,c,h);this.labels=new MathBox.Renderable.Labels(g,l,t,e,h)}});MathBox.Axis.validateArgs=function(a){"number"==typeof a&&(a={axis:a});return a};MathBox.Primitive.types.axis=MathBox.Axis;MathBox.Grid=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Grid.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{axis:[0,1],offset:[0,0,0],show:[!0,!0],n:2,ticks:[10,10],tickUnit:[1,1],tickScale:[10,10],style:{lineWidth:1,color:new THREE.Color(10526880)}}},type:function(){return"grid"},renderables:function(){return this.lines||[]},adjust:function(a){function b(a,b,c,d,e){var f=l.slice(),g=0,h=MathBox.Ticks(b.min,b.max,b.ticks,b.tickUnit,b.tickScale,!0);h.length>d&&(h=h.slice(0,d));_.each(h,function(d){f[b.axis]=d+l[b.axis];
f[c.axis]=c.min+l[c.axis];_.loop(e-1,function(b){a[g].set.apply(a[g],f);g++;f[c.axis]+=c.inv;a[g].set.apply(a[g],f);g++})});d=Math.max(0,g-1);for(h=a.length;g<h;)a[g++].copy(a[d])}var c=this.get(),d=c.axis,e=c.ticks,f=c.tickUnit,h=c.tickScale,k=c.n,g=c.show,l=c.offset,c=this.points,m=this.limit,q=[];"number"==typeof k&&(k=[k,k]);_.each(d,function(b,c){var d=a.axis(b);q.push({axis:b,min:d[0],max:d[1],inv:(d[1]-d[0])/(k[c]-1),ticks:e[c],tickUnit:f[c],tickScale:h[c]})});this.lines[0].show(g[0]);this.lines[1].show(g[1]);
g[0]&&b(c[0],q[1],q[0],m[0],k[0]);g[1]&&b(c[1],q[0],q[1],m[1],k[1])},make:function(a){var b=this.get();a=b.ticks;var c=b.n,d=this.points=[[],[]],b=this.style;"number"==typeof c&&(c=[c,c]);var e=this.limit=[0,0];_.each(a,function(a,b){b=1-b;e[b]=4*a;_.loop(e[b]*(c[b]-1)*2,function(a){d[b].push(new THREE.Vector3)})});this.lines=[];this.lines.push(new MathBox.Renderable.Mesh(d[0],{type:"line",strip:!1,dynamic:!0},b));this.lines.push(new MathBox.Renderable.Mesh(d[1],{type:"line",strip:!1,dynamic:!0},
b))}});MathBox.Primitive.types.grid=MathBox.Grid;MathBox.Vector=function(a){null!==a&&(MathBox.Primitive.call(this,a),this.render=[],this.arrows=[],this.line=this.points=this.vertices=null,this.on("change",function(a){void 0!==a.size&&_.each(this.arrows,function(c){c.set("size",a.size)})}))};MathBox.Vector.vLast=new THREE.Vector3;MathBox.Vector.vCurrent=new THREE.Vector3;
MathBox.Vector.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:1,data:null,arrow:!0,expression:function(){return 0},live:!0,style:{},size:0.07}},type:function(){return"vector"},renderables:function(){return this.render},adjust:function(a){var b=this.get();0<this.style.get("opacity")&&(b.arrow||b.live)&&this.calculate(a);_.each(this.arrows,function(a){a.show(b.arrow)})},make:function(){var a=this.get(),b=a.arrow,c=this.style,d=a.n,e=this.vertices=[],f=this.points=[],h=
this.render=[],k=this.arrows=[],g={dynamic:a.live,type:"line",strip:!1},l={size:a.size},m=0;_.loop(d,function(){e.push(new THREE.Vector3);e.push(new THREE.Vector3);f.push(new THREE.Vector3);f.push(new THREE.Vector3);if(b){var a=new MathBox.Renderable.ArrowHead(f[m++],f[m++],l,c);h.push(a);k.push(a)}});this.line=new MathBox.Renderable.Mesh(e,g,c);h.push(this.line);this.calculate()},calculate:function(a){var b=this.vertices,c=this.arrows,d=this.points,e=this.get(),f=e.data,h=e.arrow,k=e.n,g=e.size,
l=this.style.get("mathScale"),m=0,q=0;_.loop(2*k,function(k){p=f&&void 0!==f[k]?f[k]:e.expression.call(this,q,m);var t=0,s=0,r=0;if(p instanceof Array){var v=p.length;0<v&&(t=p[0]);1<v&&(s=p[1]);2<v&&(r=p[2])}else t=k,s=+p,r=0;d[k].set(t,s,r);b[k].set(t,s,r);a&&h&&1==k%2&&(t=MathBox.Vector.vLast,s=MathBox.Vector.vCurrent,s.copy(b[k]),t.copy(b[k-1]),a.to(s),a.to(t),s.subSelf(t).multiplySelf(l),v=s.length(),r=Math.min(1,0.5*v/g),r=(1-(1-r)*(1-r))*g,v-=r,s.normalize().multiplyScalar(v).divideSelf(l).addSelf(t),
a.from(s),b[k].copy(s),c[q].set({size:r}));q=m?q+1:q;m=(m+1)%2}.bind(this))}});MathBox.Primitive.types.vector=MathBox.Vector;MathBox.Surface=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Surface.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,expression:function(){return 0},live:!0,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"surface"},renderables:function(){return[this.mesh,this.line,this.points]},adjust:function(a){a=this.get();this.mesh.show(a.mesh);this.line.show(a.line);this.points.show(a.points);(a.mesh||a.line||a.points)&&0<this.style.get("opacity")&&
a.live&&this.calculate()},make:function(){var a=this.get(),b=this.style,c=a.n;"number"==typeof c&&(c=[c,c]);var d=this.geometry=new THREE.PlaneGeometry(2,2,c[0]-1,c[1]-1);this.vertices=d.vertices;this.mesh=new MathBox.Renderable.Mesh(d,{type:"mesh",doubleSided:a.doubleSided,flipSided:a.flipSided,shaded:a.shaded,smooth:!0,dynamic:a.live},b);this.line=new MathBox.Renderable.Mesh(d,{type:"mesh",shaded:a.shaded,smooth:!0,dynamic:a.live,wireframe:!0},b);this.points=new MathBox.Renderable.Mesh(d.vertices,
{type:"points",dynamic:a.live},b);if(a.shaded){var e=this.tangents=[[],[]];_.loop(c[0]*c[1],function(){e[0].push(new THREE.Vector3);e[1].push(new THREE.Vector3)})}this.calculate()},calculate:function(){var a=this.vertices,b=this.tangents,c=this.get(),d=c.data,e=c.domain,f=c.n,h=c.flipSided,k=h?1:0,h=h?0:1;"number"==typeof f&&(f=[f,f]);var g=e[0][0],l=e[1][0],m=(e[0][1]-g)/(f[0]-1),q=(e[1][1]-l)/(f[1]-1),u,t=0;_.loop(f[1],function(b){g=e[0][0];_.loop(f[0],function(e){u=d&&void 0!==d[b]&&void 0!==d[b][e]?
d[b][e]:c.expression.call(this,g,l,e,b,t);var f=e=0,h=0;if(u instanceof Array){var k=u.length;0<k&&(e=u[0]);1<k&&(f=u[1]);2<k&&(h=u[2])}else e=g,f=+u,h=l;a[t].set(e,f,h);g+=m;t++}.bind(this));l+=q}.bind(this));if(c.shaded){var t=0,l=e[1][0],s=f[0];_.loop(f[1],function(c){g=e[0][0];var d=c?c-1:0,h=Math.min(f[1]-1,c+1);_.loop(f[0],function(e){var k=e?e-1:0,l=Math.min(f[0]-1,e+1),q=a[e+c*s];l==e?b[0][t].sub(q,a[k+c*s]).addSelf(q):b[0][t].copy(a[l+c*s]);h==c?b[1][t].sub(q,a[e+d*s]).addSelf(q):b[1][t].copy(a[e+
h*s]);g+=m;t++});l+=q});this.line.set("attributes",{positionDU:b[k],positionDV:b[h]});this.mesh.set("attributes",{positionDU:b[k],positionDV:b[h]})}}});MathBox.Primitive.types.surface=MathBox.Surface;MathBox.BezierSurface=function(a){this.matrixX=new THREE.Matrix4;this.matrixY=new THREE.Matrix4;this.matrixZ=new THREE.Matrix4;this.coefficients=new THREE.Matrix4(-1,3,-3,1,3,-6,3,0,-3,3,0,0,1,0,0,0);MathBox.Surface.call(this,a)};
MathBox.BezierSurface.prototype=_.extend(new MathBox.Surface(null),{defaults:function(){return{n:[64,64],domain:[[0,1],[0,1]],data:null,order:3,expression:function(){return 0},live:!0,points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"bezierSurface"},calculate:function(){var a=this.vertices,b=this.get(),c=b.domain,d=b.data,e=b.order,f=b.shaded,h=b.n;"number"==typeof h&&(h=[h,h]);if(3!=e)throw"Bezier surface order must be 3.";var k=[],g;_.loop(e+1,function(a){_.loop(e+
1,function(c){g=d&&void 0!==d[a]&&void 0!==d[a][c]?d[a][c]:b.expression.call(this,c,a,c,a);var e=0,f=0,h=0;g instanceof Array?(c=g.length,0<c&&(e=g[0]),1<c&&(f=g[1]),2<c&&(h=g[2])):(e=c,f=+g,h=a);k.push([e,f,h])}.bind(this))}.bind(this));g=k;this.matrixX.set(g[0][0],g[1][0],g[2][0],g[3][0],g[4][0],g[5][0],g[6][0],g[7][0],g[8][0],g[9][0],g[10][0],g[11][0],g[12][0],g[13][0],g[14][0],g[15][0]);this.matrixY.set(g[0][1],g[1][1],g[2][1],g[3][1],g[4][1],g[5][1],g[6][1],g[7][1],g[8][1],g[9][1],g[10][1],g[11][1],
g[12][1],g[13][1],g[14][1],g[15][1]);this.matrixZ.set(g[0][2],g[1][2],g[2][2],g[3][2],g[4][2],g[5][2],g[6][2],g[7][2],g[8][2],g[9][2],g[10][2],g[11][2],g[12][2],g[13][2],g[14][2],g[15][2]);var l=this.coefficients;this.matrixX.multiplySelf(l).transpose().multiplySelf(l);this.matrixY.multiplySelf(l).transpose().multiplySelf(l);this.matrixZ.multiplySelf(l).transpose().multiplySelf(l);var l={bezierSurfaceX:this.matrixX,bezierSurfaceY:this.matrixY,bezierSurfaceZ:this.matrixZ},m=c[0][0],q=c[1][0],u=(c[0][1]-
m)/(h[0]-1),t=(c[1][1]-q)/(h[1]-1),s=0;_.loop(h[1],function(b){m=c[0][0];_.loop(h[0],function(b){a[s].set(m,q,0);m+=u;s++}.bind(this));q+=t}.bind(this));l={uniforms:l,shaders:{position:function(a,b){f?(a.snippet("bezierSurface"+e),a.group(),a.snippet("mathTransform"),b.viewport(a),a.next(),a.snippet("mathTransform"),b.viewport(a),a.next(),a.snippet("mathTransform"),b.viewport(a),a.combine()):(a.snippet("bezierSurface"+e).snippet("mathTransform"),b.viewport(a))}}};this.mesh.set(l);this.line.set(l);
this.points.set(l)}});MathBox.Primitive.types.bezierSurface=MathBox.BezierSurface;MathBox.Platonic=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Platonic.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{n:1,type:"cube",points:!1,line:!1,mesh:!0,doubleSided:!0,flipSided:!1,shaded:!0,style:{}}},type:function(){return"platonic"},renderables:function(){return[this.mesh,this.line,this.points]},adjust:function(a){a=this.get();this.mesh.show(a.mesh);this.line.show(a.line);this.points.show(a.points)},make:function(){var a=this.get(),b=this.style,c;switch(a.type){case "cube":c=new THREE.CubeGeometry(2,2,2,1,1,1)}this.mesh=
new MathBox.Renderable.Mesh(c,{type:"mesh",doubleSided:a.doubleSided,flipSided:a.flipSided,shaded:a.shaded,smooth:!1,dynamic:a.live},b);this.line=new MathBox.Renderable.Mesh(c,{type:"mesh",shaded:a.shaded,smooth:!1,dynamic:a.live,wireframe:!0},b);this.points=new MathBox.Renderable.Mesh(c.vertices,{type:"points",dynamic:a.live},b)}});MathBox.Primitive.types.platonic=MathBox.Platonic;MathBox.Label=function(a){null!==a&&MathBox.Primitive.call(this,a)};
MathBox.Label.prototype=_.extend(new MathBox.Primitive(null),{defaults:function(){return{position:null,facing:1,distance:15,expression:function(){return 0},style:{color:new THREE.Color(7368816)},class_name:"mathbox-labels",text:""}},renderables:function(){return[this.labels]},type:function(){return"label"},adjust:function(a,b){var c=this.get(),d=[0,0,0];d[c.facing]=1;var e=this.labelTangent;e.set.apply(e,d);d=c.position;e=this.labelPoint;d?e.set.apply(e,d):e.set.apply(e,c.expression.call(this));this.labels.show(!0)},
make:function(){var a=this.get(),b=a.position,c=a.text,d=a.distance,e=a.class_name,f=this.style,h=this.labelTangent=new THREE.Vector3,k=this.labelPoint=new THREE.Vector3,d={dynamic:!0,distance:d,class_name:e};b?k.set.apply(k,b):k.set.apply(k,a.expression.call(this));a=function(a){return c}.bind(this);this.labels=new MathBox.Renderable.Labels([k],h,a,d,f)}});MathBox.Label.validateArgs=function(a){return a};MathBox.Primitive.types.label=MathBox.Label;
MathBox.Renderable=function(a,b){if(null!==a){this.id=++MathBox.Renderable.id;var c=this.defaults();a&&(a=_.extend(c,a||{}));this.set(a||c);this.geometry=this.material=this.object=null;this.visible=!0;this.style=b||new MathBox.Style;this.style.on("change",this.styleCallback=this.refreshStyle.bind(this));this.on("change",this.uniformsCallback=this.refreshOptions.bind(this));this.mathTransform=new THREE.Matrix4}};MathBox.Renderable.id=0;
MathBox.Renderable.prototype={defaults:function(){return{}},make:function(a){},destroy:function(){},show:function(a){a=void 0===a?!0:!!a;a!=this.visible&&(this.visible=a,this.refresh())},isVisible:function(){return this.object&&this.object.visible},composeTransform:function(a,b,c){var d=THREE.Matrix4.__m1,e=THREE.Matrix4.__m2;d.identity();d.setRotationFromEuler(b,this.object.eulerOrder);e.makeScale(c.x,c.y,c.z);this.mathTransform.multiply(d,e);b=this.mathTransform.elements;b[12]=a.x;b[13]=a.y;b[14]=
a.z},refreshStyle:function(a){var b=this.style.get();a=a||b;this.material&&this.material.applyUniforms(a);if(this.object){this.object.frustumCulled=!1;a.worldPosition&&(this.object.position=b.worldPosition);a.worldRotation&&(this.object.rotation=b.worldRotation);a.worldScale&&(this.object.scale=b.worldScale);if(a.mathPosition||a.mathRotation||a.mathScale)this.composeTransform(b.mathPosition,b.mathRotation,b.mathScale),this.material&&this.material.applyUniforms({mathTransform:this.mathTransform});
void 0!==a.opacity&&(this.object.visible=this.visible&&0<b.opacity);void 0===a.opacity&&void 0===a.zIndex||!this.material||(this.object.renderDepth=b.zIndex*(1==b.opacity?1:-1))}},refreshOptions:function(a){var b=this.get();a=a||b;if(this.material){b=this.get();if(void 0!==a.doubleSided||void 0!==a.flipSided)this.material.side=b.doubleSided?THREE.DoubleSide:b.flipSided?THREE.BackSide:THREE.FrontSide,b={flipSided:b.doubleSided&&b.flipSided?-1:1},this.material.applyUniforms(b);(b=this.get().uniforms)&&
this.material.applyUniforms(b);(b=this.get().attributes)&&this.material.applyAttributes(b)}},refresh:function(){this.refreshStyle();this.refreshOptions()},adjust:function(a){this.material&&this.material.applyUniforms(a.uniforms())}};MathBox.Attributes.mixin(MathBox.Renderable);MathBox.Renderable.Mesh=function(a,b,c){this.points=a;MathBox.Renderable.call(this,b,c)};
MathBox.Renderable.Mesh.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{type:"points",doubleSided:!0,dynamic:!1,absolute:!1,strip:!0,shaders:{}}},make:function(a){var b=this.get(),c=b.type,d=b.strip,e={points:THREE.ParticleSystem,line:THREE.Line,mesh:THREE.Mesh}[c];if(!e)throw"Invalid Mesh type '"+c+"'";a=this.material=a.generic(b);var f;f=this.points;f instanceof Array?(f=this.geometry=new THREE.Geometry,f.vertices=this.points):f=this.geometry=f;f.dynamic=b.dynamic;switch(c){case "line":b=
new THREE.Line(f,a,d?THREE.LineStrip:THREE.LinePieces);break;default:b=new e(f,a)}this.object=b;this.refresh()},adjust:function(a){this.get().dynamic&&(this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Renderable.ArrowHead=function(a,b,c,d){this.from=a;this.to=b;MathBox.Renderable.call(this,c,d)};MathBox.Renderable.ArrowHead.geometry=new THREE.CylinderGeometry(0.33,0,1,16,1);
MathBox.Renderable.ArrowHead.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{offset:0,absolute:!0,size:0.1}},make:function(a){var b=this.get();a=this.material=a.generic(b);this._from=new THREE.Vector3;this._to=new THREE.Vector3;this.diff=new THREE.Vector3;this.bi=new THREE.Vector3;this.normal=new THREE.Vector3(0,0,1);b=this.geometry=MathBox.Renderable.ArrowHead.geometry;this.object=new THREE.Mesh(b,a);this.refresh()},isVisible:function(){return this.visible&&0<this.style.get("opacity")},
adjust:function(a){var b=this.get(),c=b.offset,d=this._from.copy(this.from),e=this._to.copy(this.to);this.mathTransform.multiplyVector3(d);this.mathTransform.multiplyVector3(e);a.to(d);a.to(e);d=this.diff.sub(d,e);if(0.001>d.length())this.object.visible=!1;else{this.object.visible=this.visible;d=d.normalize();this.normal.x=this.diff.y+0.1;this.normal.y=this.diff.z+0.2;this.normal.z=this.diff.x+0.3;this.normal.normalize();var f=this.bi.cross(this.normal,this.diff).normalize(),h=this.normal.cross(this.bi,
this.diff),b=b.size,e=(new THREE.Matrix4(f.x,d.x,h.x,e.x,f.y,d.y,h.y,e.y,f.z,d.z,h.z,e.z,0,0,0,1)).scale(new THREE.Vector3(b,b,b));this.object.updateMatrix();this.object.matrix.multiplySelf(e);e.identity().setPosition({x:0,y:0.5-c,z:0});this.object.matrix.multiplySelf(e);this.object.matrixAutoUpdate=!1;this.object.matrixWorldNeedsUpdate=!0;MathBox.Renderable.prototype.adjust.call(this,a)}}});
MathBox.Renderable.Ticks=function(a,b,c,d,e){this.points=a;this.signs=b;this.epsilon=c;MathBox.Renderable.call(this,d,e)};
MathBox.Renderable.Ticks.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{dynamic:!1,absolute:!1,size:0.1}},make:function(a){var b=this.get(),c=this.points;a=this.material=a.generic({type:"line",shaders:{position:function(a,c){c.position(a,b);a.snippet("tickVertexSplit");a.group();c.viewport(a);a.next();c.viewport(a);a.combine();a.snippet("tickVertexJoin")}}});var d=this.geometry=new THREE.Geometry;d.vertices=c;this.object=new THREE.Line(d,a,THREE.LinePieces);this.refresh()},
adjust:function(a){var b=this.get();this.material&&this.material.applyAttributes({tickSign:this.signs});this.material&&this.material.applyUniforms({tickEpsilon:this.epsilon,tickSize:b.size});b.dynamic&&(this.material.attributes.tickSign.needsUpdate=!0,this.geometry.verticesNeedUpdate=!0);MathBox.Renderable.prototype.adjust.call(this,a)}});MathBox.Renderable.Labels=function(a,b,c,d,e){this.points=a;this.tangent=b;this.callback=c;this.sprites=[];MathBox.Renderable.call(this,d,e)};
MathBox.Renderable.Labels.prototype=_.extend(new MathBox.Renderable(null),{defaults:function(){return{absolute:!0,distance:15,size:1,class_name:"mathbox-labels"}},make:function(a){a=this.get();var b=this.tangent,c=this.sprites,d=a.class_name;a=this.points.length;this._anchor=new THREE.Vector3;var e=document.createElement("div"),f=this.object=new MathBox.Sprite(e);e.className=d;_.loop(a,function(a){a=document.createElement("div");var e=document.createElement("div");a.appendChild(e);var g=new MathBox.Sprite(a,
b);"mathbox-labels"==d&&(a.className="mathbox-label");e.className="mathbox-wrap";e.style.position="relative";e.style.display="inline-block";e.style.left="-50%";e.style.top="-.5em";c.push(g);f.add(g)})},adjust:function(a,b,c,d,e){var f=this.get(),h=this.points;b=this.sprites;var k=this.callback,g=f.decimals,l=this.style.get("opacity"),m=window.MathJax&&MathJax.Hub,q=1/Math.log(10);_.each(b,function(b,c){b.position.copy(h[c]);a.to(b.position);e.matrix.multiplyVector3(b.position);b.distance=f.distance;
b.opacity=l;var d="";if(k){d=k(c);void 0===d&&(d="");if(+d==d){var r=+d;if(0!=r)var d=0>r?-1:1,r=Math.abs(r),v=Math.pow(10,g-1-Math.floor(Math.log(r)*q)),d=r=d*Math.round(v*r)/v}m||(d=(""+d).replace(/^-/,"\u2013"))}b.content!==d&&(r=b.element.children[0],b.content=d,b.measure=!0,m?(r.innerHTML="\\("+d+"\\)",MathJax.Hub.queue.Push(["Typeset",MathJax.Hub,r])):r.innerHTML=d)});MathBox.Renderable.prototype.adjust.call(this,a)}});
MathBox.Viewport=function(a){if(null!==a){var b=this.defaults();a=_.extend(b,a||{});this.set(a);this.singleton="viewport";this._uniforms={}}};
MathBox.Viewport.prototype={defaults:function(){return{type:"none",rotation:[0,0,0],position:[0,0,0]}},uniforms:function(){return this._uniforms},axis:function(a){return[0,1]},to:function(a){},from:function(a){},update:function(a){var b=this.get();_.each(["position","rotation"],function(c){a[c].set.apply(a[c],b[c])})},shader:function(a){a.snippet("mathToWorld")},validateRotation:function(a){return a.constructor==Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("rotation")},validatePosition:function(a){return a.constructor==
Array?(a=a.concat([0,0,0]),a.slice(0,3)):this.get("position")}};MathBox.Attributes.mixin(MathBox.Viewport,"type");MathBox.Viewport.types={};MathBox.Viewport.make=function(a){return new (MathBox.Viewport.types[a.type]||MathBox.Viewport.types.cartesian||MathBox.Viewport)(a)};
MathBox.ViewportCartesian=function(a){if(null!==a){var b=MathBox.Viewport;b.call(this,a);this.super=b.prototype;this.transform=new THREE.Matrix4;this.inverse=new THREE.Matrix4;_.extend(this._uniforms,{viewportTransform:this.transform,viewportInverse:this.inverse})}};
MathBox.ViewportCartesian.prototype=_.extend(new MathBox.Viewport(null),{defaults:function(){return{type:"cartesian",range:[[-1,1],[-1,1],[-1,1]],scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){this.transform.multiplyVector3(a)},from:function(a){this.inverse.multiplyVector3(a)},axis:function(a){var b=this.get().range[a];a=b[0];var c=b[1],b=Math.min(a,c);a=Math.max(a,c);return[b,a]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=c[0][0],e=c[1][0],f=c[2][0],h=c[0][1]-b,k=
c[1][1]-e,c=c[2][1]-f,g=d[0],l=d[1],d=d[2],m=[h/(2*g),0,0,b+h/2,0,k/(2*l),0,e+k/2,0,0,c/(2*d),f+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*g/h,0,0,-(2*b+h)*g/h,0,2*l/k,0,-(2*e+k)*l/k,0,0,2*d/c,-(2*f+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,m);MathBox.Viewport.prototype.update.call(this,a)},validateRange:function(a){a=a||[];for(var b=0;3>b;++b){a[b]=a[b]||[];for(var c=0;2>c;++c)a[b][c]=void 0!==a[b][c]?a[b][c]:2*c-1}return a},validateScale:function(a){a=a||[];for(var b=0;3>
b;++b)a[b]=a[b]||1;return a}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.cartesian=MathBox.ViewportCartesian;MathBox.ViewportPolar=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{polarAlpha:0,polarAspect:1,polarPower:1,polarFold:1,polarFocus:1,polarHelix:0})};
MathBox.ViewportPolar.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"polar",range:[[-1,1],[-1,1],[-1,1]],polar:1,fold:1,power:1,helix:0,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,e=this._uniforms.polarPower,f=this._uniforms.polarHelix;a.x*=this._uniforms.polarFold;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),e);if(1E-4<d){var e=c+a.y*b,h=a.x*d;a.z+=
a.x*f*d;a.x=Math.sin(h)*e;a.y=(Math.cos(h)*e-c)/b}this.transform.multiplyVector3(a)},from:function(a){var b=this._uniforms.polarAspect,c=this._uniforms.polarFocus,d=this._uniforms.polarAlpha,e=this._uniforms.polarFold,f=this._uniforms.polarPower,h=this._uniforms.polarHelix;this.inverse.multiplyVector3(a);if(1E-4<d){var k=a.x,g=a.y*b+c,l=Math.sqrt(k*k+g*g);theta=Math.atan2(k,g);a.x=theta/d;a.y=(l-c)/b;a.z-=a.x*h*d}a.x/=e;a.y=Math.sign(a.y)*Math.pow(Math.abs(a.y),1/f)},axis:function(a){var b=this.super.axis.call(this,
a);min=b[0];max=b[1];alpha=this._uniforms.polarAlpha;aspect=this._uniforms.polarAspect;focus=this._uniforms.polarFocus;1==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspect+0.001,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,e=b.polar,f=b.fold,h=b.power,b=b.helix,k=1,g=c[0][0],l=c[1][0],m=c[2][0],q=c[0][1]-g,u=c[1][1]-l,c=c[2][1]-m,t=d[0],s=d[1],d=d[2],k=0<q?1:-1,r=Math.abs(u),r=q+(r*k-q)*e,k=Math.abs(r/t/(u/s)),v=[r/(2*t),0,0,g+q/2,
0,u/(2*s),0,l+u/2,0,0,c/(2*d),m+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*t/r,0,0,-(2*g+q)*t/q,0,2*s/u,0,-(2*l+u)*s/u,0,0,2*d/c,-(2*m+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,v);this._uniforms.polarAlpha=e;this._uniforms.polarAspect=k;this._uniforms.polarFold=f;this._uniforms.polarPower=h;this._uniforms.polarFocus=0<e?1/e-1:0;this._uniforms.polarHelix=b;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("polarPower").snippet("cartesianToPolar").snippet("mathToWorld")},
validatePolar:function(a){return Math.max(0,Math.min(1,+a||0))},validateFold:function(a){return+a||0},validatePower:function(a){return+a||0},validateHelix:function(a){return+a||0}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.polar=MathBox.ViewportPolar;MathBox.ViewportProjective=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{projectiveTransform:new THREE.Matrix4,projectiveInverse:new THREE.Matrix4})};
MathBox.ViewportProjective.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"projective",range:[[-1,1],[-1,1],[-1,1]],scale:[1,1,1],rotation:[0,0,0],position:[0,0,0],projective:[[1,0,0,0],[0,1,0,0],[0,0,1,0],[0,0,0,1]]}},to:function(a){this._uniforms.projectiveTransform.multiplyVector3(a);this.transform.multiplyVector3(a)},from:function(a){this.inverse.multiplyVector3(a);this._uniforms.projectiveInverse.multiplyVector3(a)},update:function(a){var b=this._uniforms.projectiveTransform,
c=this.get("projective");b.set.apply(b,c[0].concat(c[1],c[2],c[3]));this._uniforms.projectiveInverse.getInverse(b);MathBox.ViewportCartesian.prototype.update.call(this,a)},shader:function(a){a.snippet("projectiveTransform").snippet("mathToWorld")},validateProjective:function(a){if(a.constructor==Array){for(var b=0;3>b;++b)a[b]=a[b]&&a.constructor==Array&&a[b]||[],a[b]=a[b].concat([0,0,0,0]).slice(0,4);return a}}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.projective=MathBox.ViewportProjective;
MathBox.ViewportSphere=function(a){var b=MathBox.ViewportCartesian;b.call(this,a);this.super=b.prototype;_.extend(this._uniforms,{sphereAlpha:0,sphereAspectX:1,sphereAspectY:1,sphereYScale:1,sphereFocus:1})};
MathBox.ViewportSphere.prototype=_.extend(new MathBox.ViewportCartesian(null),{defaults:function(){return{type:"sphere",range:[[-1,1],[-1,1],[-1,1]],sphere:1,scale:[1,1,1],rotation:[0,0,0],position:[0,0,0]}},to:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,e=this._uniforms.sphereFocus,f=this._uniforms.sphereAlpha;if(1E-4<f){var h=e+a.z*b,k=a.x*f,d=a.y*f/c*d,f=Math.cos(d)*h;a.x=Math.sin(k)*f;a.y=Math.sin(d)*h*c;a.z=(Math.cos(k)*f-e)/b}this.transform.multiplyVector3(a)},
from:function(a){var b=this._uniforms.sphereAspectX,c=this._uniforms.sphereAspectY,d=this._uniforms.sphereYScale,e=this._uniforms.sphereFocus,f=this._uniforms.sphereAlpha;this.inverse.multiplyVector3(a);if(1E-4<f){var h=a.x,k=a.y/c,g=a.z*b+e,l=Math.sqrt(h*h+k*k+g*g),k=Math.atan2(k,Math.sqrt(h*h+g*g)),h=Math.atan2(h,g);a.x=h/f;a.y=k/f*c/d;a.z=(l-e)/b}},axis:function(a){var b=this.super.axis.call(this,a);min=b[0];max=b[1];alpha=this._uniforms.sphereAlpha;beta=this._uniforms.sphereBeta;aspectX=this._uniforms.sphereAspectX;
aspectY=this._uniforms.sphereAspectY;focus=this._uniforms.sphereFocus;2==a&&0<alpha&&(max=Math.max(Math.abs(max),Math.abs(min)),min=Math.max(-focus/aspectX,min));return[min,max]},update:function(a){var b=this.get(),c=b.range,d=b.scale,b=b.sphere,e=0<b?1/b-1:0,f=c[0][0],h=c[1][0],k=c[2][0],g=c[0][1]-f,l=c[1][1]-h,c=c[2][1]-k,m=d[0],q=d[1],d=d[2],u=0<g?1:-1,t=0<l?1:-1,s=Math.abs(c),u=g+(s*u-g)*b,t=l+(s*t-l)*b,s=c/d;aspectX=u/m/s;aspectY=t/q/s/aspectX;aspectZ=l/g*m/q*2;yScale=Math.min(aspectY/b,1+(aspectZ-
1)*b);s=[u/(2*m),0,0,f+g/2,0,t/(2*q),0,h+l/2,0,0,c/(2*d),k+c/2,0,0,0,1];this.transform.set.apply(this.transform,[2*m/u,0,0,-(2*f+g)*m/g,0,2*q/t,0,-(2*h+l)*q/l,0,0,2*d/c,-(2*k+c)*d/c,0,0,0,1]);this.inverse.set.apply(this.inverse,s);this._uniforms.sphereAlpha=b;this._uniforms.sphereAspectX=aspectX;this._uniforms.sphereAspectY=aspectY;this._uniforms.sphereYScale=yScale;this._uniforms.sphereFocus=e;MathBox.Viewport.prototype.update.call(this,a)},shader:function(a){a.snippet("cartesianToSphere").snippet("mathToWorld")},
validateSphere:function(a){return Math.max(0,Math.min(1,+a||0))}});MathBox.Attributes.mixin(MathBox.Viewport);MathBox.Viewport.types.sphere=MathBox.ViewportSphere;
